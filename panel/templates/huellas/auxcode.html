{% extends 'index_master.html' %}

{% block content %}
<style>
    .filter-control {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      .filter-control label {
        width: 110px; /* ancho fijo para que queden alineados */
        text-align: right;
        margin-right: 10px;
      }
      .filter-controls {
        max-width: 350px;
        margin: 0 auto;
      }
    .filtered-image-container {
        width: 500px;  /* Ancho fijo, puedes ajustarlo */
        height: 500px; /* Alto fijo, puedes ajustarlo */
        border: 1px solid #ddd;
        margin: auto;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f0f0f0;
    }
    
    .filtered-image-container img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* Mantiene la proporción de la imagen */
    }
   
      
      
</style>
<div class="right_col" role="main">
    <h1>Cotejo de Huellas Dactilares</h1>
    <div class="col-md-12 col-sm-12 ">
        <div class="x_panel">
            <div class="x_title">
                <h2>AREA #1<small>Editar Imagen</small></h2>
                <div class="d-flex justify-content-end">
                    <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="row">
                    <div class="container cropper">
                        <div class="row text-center">
                            <div class="col-md-6">
                                <h2>Huella #1</h2>
                            </div>
                            <div class="col-md-6">
                                <h2>Huella #2</h2>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="img-container">
                                    <img id="image1" src="../media/inicio.png" alt="Picture 1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="img-container">
                                    <img id="image2" src="../media/inicio.png" alt="Picture 2">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 docs-buttons text-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="move" title="Move" onclick="setDragMode(cropper1, 'move')">
                                        <span class="fa fa-arrows"></span>
                                    </button>
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="crop" title="Crop" onclick="setDragMode(cropper1, 'crop')">
                                        <span class="fa fa-crop"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="0.1" title="Zoom In" onclick="zoom(cropper1, 0.1)">
                                        <span class="fa fa-search-plus"></span>
                                    </button>
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="-0.1" title="Zoom Out" onclick="zoom(cropper1, -0.1)">
                                        <span class="fa fa-search-minus"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="1" title="Rotate 1°" onclick="rotate(cropper1, 1)">
                                        <span class="fa fa-rotate-right"></span>
                                    </button>
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="-1" title="Rotate -1°" onclick="rotate(cropper1, -1)">
                                        <span class="fa fa-rotate-left"></span>
                                    </button>
                                    
                                </div>
                                <div class="btn-group">
                                    
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="horizontal" title="Flip Horizontal" onclick="flip(cropper1, 'horizontal')">
                                        <span class="fa fa-arrow-left"></span>
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="vertical" title="Flip Vertical" onclick="flip(cropper1, 'vertical')">
                                        <span class="fa fa-arrow-up"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-danger" data-method="reset" title="Reset" onclick="reset(cropper1)">
                                        <span class="fa fa-refresh"></span> 
                                    </button>
                                    
                                    
                                </div>
                                <div class="btn-group">
                                    
                                    <label class="btn btn-success btn-upload" for="inputImage1" title="Upload image file">
                                        <input type="file" class="sr-only" id="inputImage1" name="file" accept="image/*"> 
                                        <span class="fa fa-upload"></span> Huella 1
                                    </label>
                                    
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-dark" title="Bloquear Edición" onclick="toggleLock(cropper1)">
                                        <span class="fa fa-lock"></span> Bloquear Edición
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 docs-buttons text-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="move" title="Move" onclick="setDragMode(cropper2, 'move')">
                                        <span class="fa fa-arrows"></span>
                                    </button>
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="crop" title="Crop" onclick="setDragMode(cropper2, 'crop')">
                                        <span class="fa fa-crop"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="0.1" title="Zoom In" onclick="zoom(cropper2, 0.1)">
                                        <span class="fa fa-search-plus"></span>
                                    </button>
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="-0.1" title="Zoom Out" onclick="zoom(cropper2, -0.1)">
                                        <span class="fa fa-search-minus"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="1" title="Rotate 1°" onclick="rotate(cropper2, 1)">
                                        <span class="fa fa-rotate-right"></span>
                                    </button>
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="-1" title="Rotate -1°" onclick="rotate(cropper2, -1)">
                                        <span class="fa fa-rotate-left"></span>
                                    </button>
                                    
                                </div>
                                <div class="btn-group">
                                    
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="horizontal" title="Flip Horizontal" onclick="flip(cropper2, 'horizontal')">
                                        <span class="fa fa-arrow-left"></span>
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="vertical" title="Flip Vertical" onclick="flip(cropper2, 'vertical')">
                                        <span class="fa fa-arrow-up"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-danger" data-method="reset" title="Reset" onclick="reset(cropper2)">
                                        <span class="fa fa-refresh"></span>
                                    </button>
                                    
                                
                                </div>
                                <div class="btn-group">
                                    
                                    <label class="btn btn-success btn-upload" for="inputImage2" title="Upload image file">
                                        <input type="file" class="sr-only" id="inputImage2" name="file" accept="image/*"> 
                                        <span class="fa fa-upload"></span> Huella 2
                                    </label>
                                
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-dark" title="Bloquear Edición" onclick="toggleLock(cropper2)">
                                        <span class="fa fa-lock"></span> Bloquear Edición
                                    </button>
                                </div>
                                
                            </div>
                        </div>

                        <br/>
                        <hr/>
                        <div class="row">
                            <div class="col-md-12 docs-buttons text-center">
                                <button type="button"  class="btn btn-secondary">
                                    <span class="fa fa-fast-forward"></span> Omitir (Filtrado Automático)
                                </button>
                                <button type="button" class="btn btn-primary" onclick="showFilteredImages()">
                                    <span class="fa fa-filter"></span> Enviar a Filtrado
                                </button>
                            </div>
                        </div>
                        <div id="filter-section" style="display: none; margin-top: 20px;">
                            <div class="row text-center">
                              <!-- Contenedor para Huella #1 -->
                              <div class="col-md-6">
                                <h3>Huella #1 (Filtrada)</h3>
                                <div class="filtered-image-container">
                                    <img id="filtered-image1" src="" alt="Imagen Filtrada 1" style="max-width:100%;">
                                  </div>
                                <div class="filter-controls mt-2">
                                  <!-- Controles de filtro para la imagen 1 -->
                                  <div class="filter-control">
                                    <label for="brightness1">Brillo:</label>
                                    <input type="range" id="brightness1" min="0" max="200" value="100" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="contrast1">Contraste:</label>
                                    <input type="range" id="contrast1" min="0" max="200" value="100" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="saturation1">Saturación:</label>
                                    <input type="range" id="saturation1" min="0" max="200" value="100" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="grayscale1">Escala de grises:</label>
                                    <input type="range" id="grayscale1" min="0" max="100" value="0" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="sepia1">Sepia:</label>
                                    <input type="range" id="sepia1" min="0" max="100" value="0" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="invert1">Invertir:</label>
                                    <input type="range" id="invert1" min="0" max="100" value="0" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="hue1">Rotar Matiz:</label>
                                    <input type="range" id="hue1" min="0" max="360" value="0" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="blur1">Desenfoque:</label>
                                    <input type="range" id="blur1" min="0" max="10" value="0" step="0.1" onchange="updateFilter(1)">
                                  </div>
                                </div>
                              </div>
                              <!-- Contenedor para Huella #2 -->
                              <div class="col-md-6">
                                <h3>Huella #2 (Filtrada)</h3>
                                <div class="filtered-image-container">
                                    <img id="filtered-image2" src="" alt="Imagen Filtrada 2" style="max-width:100%;">
                                  </div>
                                <div class="filter-controls mt-2">
                                  <!-- Controles de filtro para la imagen 2 -->
                                  <div class="filter-control">
                                    <label for="brightness2">Brillo:</label>
                                    <input type="range" id="brightness2" min="0" max="200" value="100" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="contrast2">Contraste:</label>
                                    <input type="range" id="contrast2" min="0" max="200" value="100" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="saturation2">Saturación:</label>
                                    <input type="range" id="saturation2" min="0" max="200" value="100" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="grayscale2">Escala de grises:</label>
                                    <input type="range" id="grayscale2" min="0" max="100" value="0" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="sepia2">Sepia:</label>
                                    <input type="range" id="sepia2" min="0" max="100" value="0" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="invert2">Invertir:</label>
                                    <input type="range" id="invert2" min="0" max="100" value="0" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="hue2">Rotar Matiz:</label>
                                    <input type="range" id="hue2" min="0" max="360" value="0" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="blur2">Desenfoque:</label>
                                    <input type="range" id="blur2" min="0" max="10" value="0" step="0.1" onchange="updateFilter(2)">
                                  </div>
                                </div>
                              </div>
                            </div>
                            <br/>
                            <hr/>
                            <div class="row">
                              <div class="col-md-12 docs-buttons text-center">
                                <button type="button" class="btn btn-primary" onclick="enviarImagenFiltrada()">
                                  <span class="fa fa-save"></span> Guardar y Enviar a Fase de Binalizado
                                </button>
                              </div>
                            </div>
                        </div>
                          
        
                    </div> 
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-12 col-sm-12 ">
        <div class="x_panel">
          <div class="x_title">
            <h2>AREA #2 <small>Editar Imagen</small></h2>
            <div class="d-flex justify-content-end">
              <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
            </div>
            <div class="clearfix"></div>
          </div>
          <div class="x_content">
            <div class="row">
              <div class="container cropper">
                <div class="row text-center">
                  <div class="col-md-6">
                    <h2>Huella Binalizada #1</h2>
                  </div>
                  <div class="col-md-6">
                    <h2>Huella Binalizada #2</h2>
                  </div>
                </div>
            </div>
        </div>
    </div>

               <!-- HTML para cargar y procesar imágenes -->
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <div class="filtered-image-container">
                        <img id="binalizada1" src="../media/inicio.png" alt="Huella Binalizada 1">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filtered-image-container">
                        <img id="binalizada2" src="../media/inicio.png" alt="Huella Binalizada 2">
                    </div>
                </div>
            </div>
            <br/>
            <div class="text-center">
                <button type="button" class="btn btn-primary" onclick="procesarImagenes()">
                    <span class="fa fa-filter"></span> Mostrar puntos
                </button>
            </div>
            <hr/>
      
            <div class="row">
                <div class="col-md-6">
                    <!-- <div class="filtered-image-container"> -->
                        <!-- <img id="imagen_esqueletizada1" src="" alt="Imagen Esqueletizada 1"> -->
                        <canvas id="canvasProcesada1" style="border: 1px solid black;"></canvas>

<!-- 
                    </div> -->
                    
                </div>
                <div class="col-md-6">
                    <!-- <div class="filtered-image-container"> -->
                        <!-- <img id="imagen_esqueletizada2" src="" alt="Imagen Esqueletizada 2"> -->
                        <canvas id="canvasProcesada2" style="border: 1px solid black;"></canvas>
                    <!-- </div> -->
                    
                </div>
                <button id="eliminarNoCotejados">Depurar Puntos</button>
            </div>
            
        </div>
    </div>
</div>

  <div id="deletePointModal" style="display:none;">
    <button id="confirmDelete">Eliminar Punto</button>
    <button id="marcarCotejo">Marcar para Cotejo</button>
    <button id="cancelDelete">Cancelar</button>
  </div>
  
  <!-- Botón para eliminar puntos no cotejados -->
  
        
 
                        
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.js"></script>
<script>

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
    let cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        let cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
        }
    }
    }
    return cookieValue;
}


function getFilteredCanvas(imageElement) {

    if (!imageElement.complete) {
    alert("La imagen no está completamente cargada.");
    return null;
    }
    const canvas = document.createElement('canvas');
    canvas.width = imageElement.naturalWidth;
    canvas.height = imageElement.naturalHeight;
    const ctx = canvas.getContext('2d');
    ctx.filter = imageElement.style.filter || '';
    ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);
    return canvas;
}

function enviarImagenFiltrada() {
    const csrfToken = getCookie('csrftoken');
    let imgEl1 = document.getElementById('filtered-image1');
    let imgEl2 = document.getElementById('filtered-image2');

    if (!imgEl1.src || !imgEl2.src) {
    alert('No se han aplicado filtros a ambas imágenes.');
    return;
    }

    let canvas1 = getFilteredCanvas(imgEl1);
    let canvas2 = getFilteredCanvas(imgEl2);

    if (!canvas1 || !canvas2) {
    alert("Error al procesar las imágenes filtradas.");
    return;
    }
    
    function dataURLToBlob(dataURL) {
    const parts = dataURL.split(',');
    const byteString = atob(parts[1]);
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ia], { type: 'image/jpeg' });
    }

    let dataURL1 = canvas1.toDataURL('image/jpeg');
    let dataURL2 = canvas2.toDataURL('image/jpeg');

    let blob1 = dataURLToBlob(dataURL1);
    let blob2 = dataURLToBlob(dataURL2);

    let formData = new FormData();
    formData.append('imagen', blob1, 'imagen1.jpg');
    formData.append('imagen2', blob2, 'imagen2.jpg');

    fetch('/binalizado_automatico/', {
    method: 'POST',
    body: formData,
    headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
    }
    })
    .then(response => response.json())
    .then(data => {
    if (data.imagen_procesada1) {
        document.getElementById('binalizada1').src = 'data:image/jpeg;base64,' + data.imagen_procesada1;
    }
    if (data.imagen_procesada2) {
        document.getElementById('binalizada2').src = 'data:image/jpeg;base64,' + data.imagen_procesada2;
    }
    if (data.error) {
        alert('Error: ' + data.error);
    }
    })
    .catch(error => console.error('Error al enviar las imágenes:', error));
}

let isLocked1 = false;
    let isLocked2 = false;
    
    function toggleLock(cropper) {
        if (cropper === cropper1) {
            isLocked1 = !isLocked1;  
            if (isLocked1) {
                cropper1.disable();  
                alert("Edición de Huella 1 bloqueada.");
            } else {
                cropper1.enable();  
                alert("Edición de Huella 1 desbloqueada.");
            }
        } else if (cropper === cropper2) {
            isLocked2 = !isLocked2;  
            if (isLocked2) {
                cropper2.disable();
                alert("Edición de Huella 2 bloqueada.");
            } else {
                cropper2.enable();
                alert("Edición de Huella 2 desbloqueada.");
            }
        }
    }

function showFilteredImages() {
    var croppedImage1 = cropper1.getCroppedCanvas();
    var croppedImage2 = cropper2.getCroppedCanvas();
    document.getElementById('filtered-image1').src = croppedImage1.toDataURL();
    document.getElementById('filtered-image2').src = croppedImage2.toDataURL();
    document.getElementById('filter-section').style.display = 'block';
}

function updateFilter(imageNumber) {
    var brightness = document.getElementById('brightness' + imageNumber).value;
    var contrast = document.getElementById('contrast' + imageNumber).value;
    var saturation = document.getElementById('saturation' + imageNumber).value;
    var grayscale = document.getElementById('grayscale' + imageNumber).value;
    var sepia = document.getElementById('sepia' + imageNumber).value;
    var invert = document.getElementById('invert' + imageNumber).value;
    var hue = document.getElementById('hue' + imageNumber).value;
    var blur = document.getElementById('blur' + imageNumber).value;

    var combinedFilter = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%) ` +
                        `grayscale(${grayscale}%) sepia(${sepia}%) invert(${invert}%) ` +
                        `hue-rotate(${hue}deg) blur(${blur}px)`;
    document.getElementById('filtered-image' + imageNumber).style.filter = combinedFilter;
}

var cropper1, cropper2;
var image1 = document.getElementById('image1');
cropper1 = new Cropper(image1, {
    autoCropArea: 0.65,
    responsive: true,
    zoomable: true,
    scalable: true,
    movable: true
});
var image2 = document.getElementById('image2');
cropper2 = new Cropper(image2, {
    autoCropArea: 0.65,
    responsive: true,
    zoomable: true,
    scalable: true,
    movable: true
});

function loadImage(input, cropper) {
    var file = input.files[0];
    var reader = new FileReader();
    reader.onload = function (e) {
        var url = e.target.result;
        cropper.replace(url);
    };
    reader.readAsDataURL(file);
}

document.getElementById('inputImage1').addEventListener('change', function (e) {
    loadImage(e.target, cropper1);
});
document.getElementById('inputImage2').addEventListener('change', function (e) {
    loadImage(e.target, cropper2);
});

function setDragMode(cropper, mode) {
    cropper.setDragMode(mode);
}
function zoom(cropper, level) {
    cropper.zoom(level);
}
function rotate(cropper, degree) {
    cropper.rotate(degree);
}
function flip(cropper, direction) {
    cropper.scaleX(direction === 'horizontal' ? -1 : 1);
    cropper.scaleY(direction === 'vertical' ? -1 : 1);
}
function reset(cropper) {
    cropper.reset();
}
function destroy(cropper) {
    cropper.destroy();
}
</script>

<script>
    // function getCookie(name) {
    //     let cookieValue = null;
    //     if (document.cookie && document.cookie !== '') {
    //         let cookies = document.cookie.split(';');
    //         for (let i = 0; i < cookies.length; i++) {
    //             let cookie = cookies[i].trim();
    //             // Busca la cookie que empieza con el nombre dado
    //             if (cookie.substring(0, name.length + 1) === (name + '=')) {
    //                 cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
    //                 break;
    //             }
    //         }
    //     }
    //     return cookieValue;
    // }
    
    // function procesarImagenes() {
    //     const formData = new FormData();
    //     const img1 = document.getElementById('binalizada1');
    //     const img2 = document.getElementById('binalizada2');
    //     if (!img1.complete || !img2.complete) {
    //         alert("Asegúrate de que ambas imágenes estén completamente cargadas.");
    //         return;
    //     }
    
    //     const canvas1 = document.createElement('canvas');
    //     canvas1.width = img1.naturalWidth;
    //     canvas1.height = img1.naturalHeight;
    //     const ctx1 = canvas1.getContext('2d');
    //     ctx1.drawImage(img1, 0, 0, canvas1.width, canvas1.height);
    //     const dataURL1 = canvas1.toDataURL('image/png');
    //     const canvas2 = document.createElement('canvas');
    //     canvas2.width = img2.naturalWidth;
    //     canvas2.height = img2.naturalHeight;
    //     const ctx2 = canvas2.getContext('2d');
    //     ctx2.drawImage(img2, 0, 0, canvas2.width, canvas2.height);
    //     const dataURL2 = canvas2.toDataURL('image/png');
    //     const base64Image1 = dataURL1.split(',')[1];
    //     const base64Image2 = dataURL2.split(',')[1];
    //     formData.append('imagen1', base64Image1);
    //     formData.append('imagen2', base64Image2);
    //     fetch('/procesar_imagenes/', {
    //         method: 'POST',
    //         body: formData,
    //         headers: {
    //             'X-CSRFToken': getCookie('csrftoken')
    //         }
    //     })
    //     .then(response => response.json())
    //     .then(data => {
    //         document.getElementById('imagen_esqueletizada1').src = data.imagen_esqueletizada1;
    //         document.getElementById('imagen_esqueletizada2').src = data.imagen_esqueletizada2;
    
           
    //     })
    //     .catch(error => console.error('Error al procesar las imágenes:', error));
    // }
    
// Variables globales para almacenar puntos de cada imagen
let puntosTerminacion1 = [];
let puntosBifurcacion1 = [];
let puntosTerminacion2 = [];
let puntosBifurcacion2 = [];

// Lista de cotejo (puntos seleccionados para cotejo)
let puntosCotejo = [];

// Variable para la eliminación mediante modal
let pendingDeletion = null;  // Objeto: { canvasId, tipo ('termino' o 'bifur'), indice }

// Función para procesar las imágenes y cargar los canvas
function procesarImagenes() {
    const formData = new FormData();
    const img1 = document.getElementById('binalizada1');
    const img2 = document.getElementById('binalizada2');
    if (!img1.complete || !img2.complete) {
        alert("Asegúrate de que ambas imágenes estén completamente cargadas.");
        return;
    }

    // Procesar la primera imagen
    const canvasTemp1 = document.createElement('canvas');
    canvasTemp1.width = img1.naturalWidth;
    canvasTemp1.height = img1.naturalHeight;
    const ctxTemp1 = canvasTemp1.getContext('2d');
    ctxTemp1.drawImage(img1, 0, 0, canvasTemp1.width, canvasTemp1.height);
    const dataURL1 = canvasTemp1.toDataURL('image/png');
    const base64Image1 = dataURL1.split(',')[1];

    // Procesar la segunda imagen
    const canvasTemp2 = document.createElement('canvas');
    canvasTemp2.width = img2.naturalWidth;
    canvasTemp2.height = img2.naturalHeight;
    const ctxTemp2 = canvasTemp2.getContext('2d');
    ctxTemp2.drawImage(img2, 0, 0, canvasTemp2.width, canvasTemp2.height);
    const dataURL2 = canvasTemp2.toDataURL('image/png');
    const base64Image2 = dataURL2.split(',')[1];

    formData.append('imagen1', base64Image1);
    formData.append('imagen2', base64Image2);

    fetch('/procesar_imagenes/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        // Cargar la primera imagen en su canvas
        cargarCanvas('canvasProcesada1', data.imagen_esqueletizada1, data.resultados1, 1);
        // Cargar la segunda imagen en su canvas
        cargarCanvas('canvasProcesada2', data.imagen_esqueletizada2, data.resultados2, 2);
    })
    .catch(error => console.error('Error al procesar las imágenes:', error));
}

// Función para cargar la imagen en el canvas y dibujar los puntos
function cargarCanvas(canvasId, imagenDataURL, resultados, numCanvas) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const img = new Image();
    img.onload = function() {
        // Ajustar el tamaño del canvas según la imagen
        canvas.width = img.width;
        canvas.height = img.height;
        // Dibujar la imagen limpia
        ctx.drawImage(img, 0, 0);
        // Guardar la imagen limpia en un atributo para redibujar luego
        canvas.setAttribute('data-img', imagenDataURL);
        // Guardar puntos según el canvas que se esté procesando (sin alterar el orden original)
        if (numCanvas === 1) {
            puntosTerminacion1 = resultados.terminoX.map((x, index) => ({ x: x, y: resultados.terminoY[index] }));
            puntosBifurcacion1 = resultados.bifurX.map((x, index) => ({ x: x, y: resultados.bifurY[index] }));
        } else if (numCanvas === 2) {
            puntosTerminacion2 = resultados.terminoX.map((x, index) => ({ x: x, y: resultados.terminoY[index] }));
            puntosBifurcacion2 = resultados.bifurX.map((x, index) => ({ x: x, y: resultados.bifurY[index] }));
        }
        dibujarPuntos(canvasId, numCanvas);
    }
    img.src = imagenDataURL;
}

// Función para dibujar los puntos en el canvas correspondiente
function dibujarPuntos(canvasId, numCanvas) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const grosorBorde = 3; // Ajusta este valor para cambiar el grosor del borde

    // Elegir los conjuntos de puntos en función del canvas
    let puntosTerminacion, puntosBifurcacion;
    if (numCanvas === 1) {
        puntosTerminacion = puntosTerminacion1;
        puntosBifurcacion = puntosBifurcacion1;
    } else {
        puntosTerminacion = puntosTerminacion2;
        puntosBifurcacion = puntosBifurcacion2;
    }

    // Dibujar puntos de terminación en rojo (se usa p.y como coordenada horizontal para mantener lo original)
    ctx.strokeStyle = 'red';
    ctx.lineWidth = grosorBorde;
    puntosTerminacion.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.y, p.x, 5, 0, 2 * Math.PI);
        ctx.stroke();
    });

    // Dibujar puntos de bifurcación en azul
    ctx.strokeStyle = 'blue';
    ctx.lineWidth = grosorBorde;
    puntosBifurcacion.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.y, p.x, 5, 0, 2 * Math.PI);
        ctx.stroke();
    });

    // Dibujar puntos de cotejo en naranja
    ctx.strokeStyle = 'orange';
    puntosCotejo.forEach(p => {
        if (p.canvasId === canvasId) {
            ctx.beginPath();
            ctx.arc(p.y, p.x, 5, 0, 2 * Math.PI);
            ctx.stroke();
        }
    });
}

// Función para manejar clics en cada canvas (se abre modal en vez de eliminar inmediatamente)
function handleCanvasClick(event) {
    // Identificar en qué canvas se hizo clic
    const canvas = event.target;
    const canvasId = canvas.id;
    const rect = canvas.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const clickY = event.clientY - rect.top;
    const radioDeteccion = 7; // Radio de detección para el clic

    // Seleccionar los conjuntos de puntos según el canvas
    let puntosTerminacion, puntosBifurcacion;
    if (canvasId === 'canvasProcesada1') {
        puntosTerminacion = puntosTerminacion1;
        puntosBifurcacion = puntosBifurcacion1;
    } else if (canvasId === 'canvasProcesada2') {
        puntosTerminacion = puntosTerminacion2;
        puntosBifurcacion = puntosBifurcacion2;
    }

    // Buscar punto cercano en ambos conjuntos
    let puntoEncontrado = null;
    let tipo = null;
    let indice = -1;
    
    // Buscar en terminaciones
    for (let i = 0; i < puntosTerminacion.length; i++) {
        // Se compara usando la misma lógica original (p.y con clickX y p.x con clickY)
        const dist = Math.sqrt(Math.pow(puntosTerminacion[i].y - clickX, 2) + Math.pow(puntosTerminacion[i].x - clickY, 2));
        if (dist < radioDeteccion) {
            puntoEncontrado = puntosTerminacion[i];
            tipo = 'termino';
            indice = i;
            break;
        }
    }
    // Si no se encontró en terminaciones, buscar en bifurcaciones
    if (!puntoEncontrado) {
        for (let i = 0; i < puntosBifurcacion.length; i++) {
            const dist = Math.sqrt(Math.pow(puntosBifurcacion[i].y - clickX, 2) + Math.pow(puntosBifurcacion[i].x - clickY, 2));
            if (dist < radioDeteccion) {
                puntoEncontrado = puntosBifurcacion[i];
                tipo = 'bifur';
                indice = i;
                break;
            }
        }
    }

    if (puntoEncontrado) {
        // Si se encontró un punto, guardar la info y abrir el modal
        pendingDeletion = { canvasId, tipo, indice, x: puntoEncontrado.x, y: puntoEncontrado.y };
        abrirModal();
    } else {
        // Si no se encontró punto, agregar uno nuevo para cotejo (se usa el mismo orden: x = clickY, y = clickX)
        puntosCotejo.push({ x: clickY, y: clickX, canvasId });
        redibujarCanvas(canvasId, canvasId === 'canvasProcesada1' ? 1 : 2);
    }
}

// Función para abrir el modal
function abrirModal() {
    const modal = document.getElementById('deletePointModal');
    modal.style.display = 'block';
}

// Función para cerrar el modal
function cerrarModal() {
    const modal = document.getElementById('deletePointModal');
    modal.style.display = 'none';
    pendingDeletion = null;
}

// Función para confirmar la eliminación y redibujar el canvas
function confirmarEliminacion() {
    if (!pendingDeletion) return;
    
    const { canvasId, tipo, indice } = pendingDeletion;
    if (canvasId === 'canvasProcesada1') {
        if (tipo === 'termino') {
            puntosTerminacion1.splice(indice, 1);
        } else {
            puntosBifurcacion1.splice(indice, 1);
        }
        redibujarCanvas(canvasId, 1);
    } else if (canvasId === 'canvasProcesada2') {
        if (tipo === 'termino') {
            puntosTerminacion2.splice(indice, 1);
        } else {
            puntosBifurcacion2.splice(indice, 1);
        }
        redibujarCanvas(canvasId, 2);
    }
    cerrarModal();
}

// Función para marcar un punto para cotejo (opción en el modal)
function marcarParaCotejo() {
    if (!pendingDeletion) return;
    const { canvasId, x, y } = pendingDeletion;
    puntosCotejo.push({ x, y, canvasId });
    redibujarCanvas(canvasId, canvasId === 'canvasProcesada1' ? 1 : 2);
    cerrarModal();
}

// Función para eliminar (depurar) los puntos que NO están en la lista de cotejo
function eliminarPuntosNoCotejados() {
    // Filtra los puntos manteniendo solo aquellos que están en la lista de cotejo
    const filtrarPuntos = (puntos, canvasId) =>
        puntos.filter(p => puntosCotejo.some(pc => pc.x === p.x && pc.y === p.y && pc.canvasId === canvasId));

    puntosTerminacion1 = filtrarPuntos(puntosTerminacion1, 'canvasProcesada1');
    puntosBifurcacion1 = filtrarPuntos(puntosBifurcacion1, 'canvasProcesada1');
    puntosTerminacion2 = filtrarPuntos(puntosTerminacion2, 'canvasProcesada2');
    puntosBifurcacion2 = filtrarPuntos(puntosBifurcacion2, 'canvasProcesada2');

    redibujarCanvas('canvasProcesada1', 1);
    redibujarCanvas('canvasProcesada2', 2);
}

// Función para redibujar el canvas usando la imagen limpia almacenada
function redibujarCanvas(canvasId, numCanvas) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const imagenDataURL = canvas.getAttribute('data-img');
    if (!imagenDataURL) return;
    const img = new Image();
    img.onload = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        dibujarPuntos(canvasId, numCanvas);
    }
    img.src = imagenDataURL;
}

// Asignar el manejador de clics a ambos canvas
document.getElementById('canvasProcesada1').addEventListener('click', handleCanvasClick);
document.getElementById('canvasProcesada2').addEventListener('click', handleCanvasClick);

// Asignar los botones del modal
document.getElementById('confirmDelete').addEventListener('click', confirmarEliminacion);
document.getElementById('marcarCotejo').addEventListener('click', marcarParaCotejo);
document.getElementById('cancelDelete').addEventListener('click', cerrarModal);

document.getElementById('eliminarNoCotejados').addEventListener('click', eliminarPuntosNoCotejados);


</script>

{% endblock %}
{% endblock %}