{% extends 'index_master.html' %}

{% block content %}
<style>
    .filter-control {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      .filter-control label {
        width: 110px; /* ancho fijo para que queden alineados */
        text-align: right;
        margin-right: 10px;
      }
      .filter-controls {
        max-width: 350px;
        margin: 0 auto;
      }
    .filtered-image-container {
        width: 500px;  /* Ancho fijo, puedes ajustarlo */
        height: 500px; /* Alto fijo, puedes ajustarlo */
        border: 1px solid #ddd;
        margin: auto;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f0f0f0;
    }
    
    .filtered-image-container img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* Mantiene la proporción de la imagen */
    }

    /* Added styles for canvas containers and modal */
    .canvas-container {
        width: 500px;
        height: 500px;
        border: 2px solid #333;
        margin: 10px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f8f8;
        position: relative;
    }

    .canvas-container canvas {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        cursor: crosshair;
    }

    .debug-section {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
    }

    .debug-section button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
    }

    .debug-section button:hover {
        background-color: #0056b3;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: none;
        border-radius: 10px;
        width: 300px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .modal-content button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        min-width: 120px;
    }

    .modal-content button:hover {
        background-color: #0056b3;
    }

    .modal-content button.danger {
        background-color: #dc3545;
    }

    .modal-content button.danger:hover {
        background-color: #c82333;
    }

    .modal-content button.success {
        background-color: #28a745;
    }

    .modal-content button.success:hover {
        background-color: #218838;
    }

    /* Table styles */
    .points-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        background-color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .points-table th,
    .points-table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: center;
    }

    .points-table th {
        background-color: #f8f9fa;
        font-weight: bold;
        color: #495057;
    }

    .points-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    .points-table tr:hover {
        background-color: #e9ecef;
    }

    .cartesian-section {
        margin-top: 30px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
    }
   
      
      
</style>
<div class="right_col" role="main">
    <h1>Cotejo de Huellas Dactilares</h1>
    <div class="col-md-12 col-sm-12 ">
        <div class="x_panel">
            <div class="x_title">
                <h2>AREA #1<small>Editar Imagen</small></h2>
                <div class="d-flex justify-content-end">
                    <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="row">
                    <div class="container cropper">
                        <div class="row text-center">
                            <div class="col-md-6">
                                <h2>Huella #1</h2>
                            </div>
                            <div class="col-md-6">
                                <h2>Huella #2</h2>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="img-container">
                                    <img id="image1" src="../media/inicio.png" alt="Picture 1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="img-container">
                                    <img id="image2" src="../media/inicio.png" alt="Picture 2">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 docs-buttons text-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="move" title="Move" onclick="setDragMode(cropper1, 'move')">
                                        <span class="fa fa-arrows"></span>
                                    </button>
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="crop" title="Crop" onclick="setDragMode(cropper1, 'crop')">
                                        <span class="fa fa-crop"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="0.1" title="Zoom In" onclick="zoom(cropper1, 0.1)">
                                        <span class="fa fa-search-plus"></span>
                                    </button>
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="-0.1" title="Zoom Out" onclick="zoom(cropper1, -0.1)">
                                        <span class="fa fa-search-minus"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="1" title="Rotate 1°" onclick="rotate(cropper1, 1)">
                                        <span class="fa fa-rotate-right"></span>
                                    </button>
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="-1" title="Rotate -1°" onclick="rotate(cropper1, -1)">
                                        <span class="fa fa-rotate-left"></span>
                                    </button>
                                    
                                </div>
                                <div class="btn-group">
                                    
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="horizontal" title="Flip Horizontal" onclick="flip(cropper1, 'horizontal')">
                                        <span class="fa fa-arrow-left"></span>
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="vertical" title="Flip Vertical" onclick="flip(cropper1, 'vertical')">
                                        <span class="fa fa-arrow-up"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-danger" data-method="reset" title="Reset" onclick="reset(cropper1)">
                                        <span class="fa fa-refresh"></span> 
                                    </button>
                                    
                                    
                                </div>
                                <div class="btn-group">
                                    
                                    <label class="btn btn-success btn-upload" for="inputImage1" title="Upload image file">
                                        <input type="file" class="sr-only" id="inputImage1" name="file" accept="image/*"> 
                                        <span class="fa fa-upload"></span> Huella 1
                                    </label>
                                    
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-dark" title="Bloquear Edición" onclick="toggleLock(cropper1)">
                                        <span class="fa fa-lock"></span> Bloquear Edición
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 docs-buttons text-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="move" title="Move" onclick="setDragMode(cropper2, 'move')">
                                        <span class="fa fa-arrows"></span>
                                    </button>
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="crop" title="Crop" onclick="setDragMode(cropper2, 'crop')">
                                        <span class="fa fa-crop"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="0.1" title="Zoom In" onclick="zoom(cropper2, 0.1)">
                                        <span class="fa fa-search-plus"></span>
                                    </button>
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="-0.1" title="Zoom Out" onclick="zoom(cropper2, -0.1)">
                                        <span class="fa fa-search-minus"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="1" title="Rotate 1°" onclick="rotate(cropper2, 1)">
                                        <span class="fa fa-rotate-right"></span>
                                    </button>
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="-1" title="Rotate -1°" onclick="rotate(cropper2, -1)">
                                        <span class="fa fa-rotate-left"></span>
                                    </button>
                                    
                                </div>
                                <div class="btn-group">
                                    
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="horizontal" title="Flip Horizontal" onclick="flip(cropper2, 'horizontal')">
                                        <span class="fa fa-arrow-left"></span>
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="vertical" title="Flip Vertical" onclick="flip(cropper2, 'vertical')">
                                        <span class="fa fa-arrow-up"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-danger" data-method="reset" title="Reset" onclick="reset(cropper2)">
                                        <span class="fa fa-refresh"></span>
                                    </button>
                                    
                                
                                </div>
                                <div class="btn-group">
                                    
                                    <label class="btn btn-success btn-upload" for="inputImage2" title="Upload image file">
                                        <input type="file" class="sr-only" id="inputImage2" name="file" accept="image/*"> 
                                        <span class="fa fa-upload"></span> Huella 2
                                    </label>
                                
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-dark" title="Bloquear Edición" onclick="toggleLock(cropper2)">
                                        <span class="fa fa-lock"></span> Bloquear Edición
                                    </button>
                                </div>
                                
                            </div>
                        </div>

                        <br/>
                        <hr/>
                        <div class="row">
                            <div class="col-md-12 docs-buttons text-center">
                                <button type="button"  class="btn btn-secondary">
                                    <span class="fa fa-fast-forward"></span> Omitir (Filtrado Automático)
                                </button>
                                <button type="button" class="btn btn-primary" onclick="showFilteredImages()">
                                    <span class="fa fa-filter"></span> Enviar a Filtrado
                                </button>
                            </div>
                        </div>
                        <div id="filter-section" style="display: none; margin-top: 20px;">
                            <div class="row text-center">
                              <div class="col-md-6">
                                <h3>Huella #1 (Filtrada)</h3>
                                <div class="filtered-image-container">
                                    <img id="filtered-image1" src="/placeholder.svg" alt="Imagen Filtrada 1" style="max-width:100%;">
                                  </div>
                                <div class="filter-controls mt-2">
                                  <div class="filter-control">
                                    <label for="brightness1">Brillo:</label>
                                    <input type="range" id="brightness1" min="0" max="200" value="100" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="contrast1">Contraste:</label>
                                    <input type="range" id="contrast1" min="0" max="200" value="100" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="saturation1">Saturación:</label>
                                    <input type="range" id="saturation1" min="0" max="200" value="100" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="grayscale1">Escala de grises:</label>
                                    <input type="range" id="grayscale1" min="0" max="100" value="0" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="sepia1">Sepia:</label>
                                    <input type="range" id="sepia1" min="0" max="100" value="0" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="invert1">Invertir:</label>
                                    <input type="range" id="invert1" min="0" max="100" value="0" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="hue1">Rotar Matiz:</label>
                                    <input type="range" id="hue1" min="0" max="360" value="0" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="blur1">Desenfoque:</label>
                                    <input type="range" id="blur1" min="0" max="10" value="0" step="0.1" onchange="updateFilter(1)">
                                  </div>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <h3>Huella #2 (Filtrada)</h3>
                                <div class="filtered-image-container">
                                    <img id="filtered-image2" src="/placeholder.svg" alt="Imagen Filtrada 2" style="max-width:100%;">
                                  </div>
                                <div class="filter-controls mt-2">
                                  <div class="filter-control">
                                    <label for="brightness2">Brillo:</label>
                                    <input type="range" id="brightness2" min="0" max="200" value="100" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="contrast2">Contraste:</label>
                                    <input type="range" id="contrast2" min="0" max="200" value="100" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="saturation2">Saturación:</label>
                                    <input type="range" id="saturation2" min="0" max="200" value="100" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="grayscale2">Escala de grises:</label>
                                    <input type="range" id="grayscale2" min="0" max="100" value="0" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="sepia2">Sepia:</label>
                                    <input type="range" id="sepia2" min="0" max="100" value="0" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="invert2">Invertir:</label>
                                    <input type="range" id="invert2" min="0" max="100" value="0" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="hue2">Rotar Matiz:</label>
                                    <input type="range" id="hue2" min="0" max="360" value="0" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="blur2">Desenfoque:</label>
                                    <input type="range" id="blur2" min="0" max="10" value="0" step="0.1" onchange="updateFilter(2)">
                                  </div>
                                </div>
                              </div>
                            </div>
                            <br/>
                            <hr/>
                            <div class="row">
                              <div class="col-md-12 docs-buttons text-center">
                                <button type="button" class="btn btn-primary" onclick="enviarImagenFiltrada()">
                                  <span class="fa fa-send"></span> Enviar a Fase de Binalizado
                                </button>
                              </div>
                            </div>
                        </div>
                          
        
                    </div> 
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-12 col-sm-12 ">
        <div class="x_panel">
          <div class="x_title">
            <h2>AREA #2 <small>Editar Imagen</small></h2>
            <div class="d-flex justify-content-end">
              <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
            </div>
            <div class="clearfix"></div>
          </div>
          <div class="x_content">
            <div class="row">
              <div class="container cropper">
                <div class="row text-center">
                  <div class="col-md-6">
                    <h2>Huella Binalizada #1</h2>
                  </div>
                  <div class="col-md-6">
                    <h2>Huella Binalizada #2</h2>
                  </div>
                </div>
            </div>
        </div>
    </div>

        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <div class="filtered-image-container">
                        <img id="binalizada1" src="../media/inicio.png" alt="Huella Binalizada 1">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filtered-image-container">
                        <img id="binalizada2" src="../media/inicio.png" alt="Huella Binalizada 2">
                    </div>
                </div>
            </div>
            <br/>
            <div class="text-center">
                <button type="button" class="btn btn-primary" onclick="procesarImagenes()">
                    <span class="fa fa-filter"></span> Mostrar puntos
                </button>
            </div>
            <hr/>
            <div class="row">
                <div class="col-md-6">
                    <div class="canvas-container">
                        <canvas id="canvasProcesada1"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="canvas-container">
                        <canvas id="canvasProcesada2"></canvas>
                    </div>
                </div>
            </div>
            <div class="debug-section text-center">
                <h4>Opciones de Depuración</h4>
                <button id="eliminarNoCotejados">Depurar Puntos</button>
                <button id="mostrarPlanos">Mostrar Planos Cartesianos</button>
            </div>
            <div class="cartesian-section" id="cartesianSection" style="display: none;">
                <h3 class="text-center">Planos Cartesianos con Puntos Etiquetados</h3>
                <div class="row">
                    <div class="col-md-6">
                        <h4 class="text-center">Huella #1 - Plano Cartesiano</h4>
                        <div class="canvas-container">
                            <canvas id="canvasPlano1"></canvas>
                        </div>
                        <div class="text-center" style="margin-top: 10px;">
                            <button class="btn btn-warning" onclick="iniciarSeleccionManual(1)">
                                Seleccionar Puntos Plano XY Manual
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4 class="text-center">Huella #2 - Plano Cartesiano</h4>
                        <div class="canvas-container">
                            <canvas id="canvasPlano2"></canvas>
                        </div>
                        <div class="text-center" style="margin-top: 10px;">
                            <button class="btn btn-warning" onclick="iniciarSeleccionManual(2)">
                                Seleccionar Puntos Plano XY Manual
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h4>Coordenadas Huella #1</h4>
                        <table class="points-table" id="pointsTable1">
                            <thead>
                                <tr>
                                    <th>Etiqueta</th>
                                    <th>X</th>
                                    <th>Y</th>
                                    <th>Distancia al Origen</th>
                                    <th>Ángulo (°)</th>
                                </tr>
                            </thead>
                            <tbody id="pointsTableBody1">
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h4>Coordenadas Huella #2</h4>
                        <table class="points-table" id="pointsTable2">
                            <thead>
                                <tr>
                                    <th>Etiqueta</th>
                                    <th>X</th>
                                    <th>Y</th>
                                    <th>Distancia al Origen</th>
                                    <th>Ángulo (°)</th>
                                </tr>
                            </thead>
                            <tbody id="pointsTableBody2">
                            </tbody>
                        </table>
                    </div>
                </div>
                <h3 class="text-center">Planos Cartesianos Puros (Solo Ejes y Líneas)</h3>
                <div class="row">
                    <div class="col-md-6">
                        <h4 class="text-center">Huella #1 - Plano Puro</h4>
                        <div class="canvas-container">
                            <canvas id="canvasPuro1"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4 class="text-center">Huella #2 - Plano Puro</h4>
                        <div class="canvas-container">
                            <canvas id="canvasPuro2"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<div id="deletePointModal" class="modal">
    <div class="modal-content">
        <h3>Opciones del Punto</h3>
        <p>¿Qué deseas hacer con este punto?</p>
        <button id="confirmDelete" class="danger">Eliminar Punto</button>
        <button id="marcarCotejo" class="success">Marcar para Cotejo</button>
        <button id="cancelDelete">Cancelar</button>
    </div>
</div>

<div id="manualCoordinateModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Selección Manual de Coordenadas</h3>
        <p id="modalMessage">Seleccione el primer punto X1 para dibujar el eje X de la imagen</p>
        <button id="acceptManualSelection" class="success">Aceptar</button>
        <button id="cancelManualSelection">Cancelar</button>
    </div>
</div>
  
                  
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.js"></script>
<script>

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
    let cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        let cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
        }
    }
    }
    return cookieValue;
}


function getFilteredCanvas(imageElement) {
    if (!imageElement.complete) {
    alert("La imagen no está completamente cargada.");
    return null;
    }
    const canvas = document.createElement('canvas');
    canvas.width = imageElement.naturalWidth;
    canvas.height = imageElement.naturalHeight;
    const ctx = canvas.getContext('2d');
    ctx.filter = imageElement.style.filter || '';
    ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);
    return canvas;
}

function enviarImagenFiltrada() {
    const csrfToken = getCookie('csrftoken');
    let imgEl1 = document.getElementById('filtered-image1');
    let imgEl2 = document.getElementById('filtered-image2');

    if (!imgEl1.src || !imgEl2.src) {
    alert('No se han aplicado filtros a ambas imágenes.');
    return;
    }

    let canvas1 = getFilteredCanvas(imgEl1);
    let canvas2 = getFilteredCanvas(imgEl2);

    if (!canvas1 || !canvas2) {
    alert("Error al procesar las imágenes filtradas.");
    return;
    }
    
    function dataURLToBlob(dataURL) {
    const parts = dataURL.split(',');
    const byteString = atob(parts[1]);
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ia], { type: 'image/jpeg' });
    }

    let dataURL1 = canvas1.toDataURL('image/jpeg');
    let dataURL2 = canvas2.toDataURL('image/jpeg');
    let blob1 = dataURLToBlob(dataURL1);
    let blob2 = dataURLToBlob(dataURL2);
    let formData = new FormData();
    formData.append('imagen', blob1, 'imagen1.jpg');
    formData.append('imagen2', blob2, 'imagen2.jpg');

    fetch('/binalizado_automatico/', {
    method: 'POST',
    body: formData,
    headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
    }
    })
    .then(response => response.json())
    .then(data => {
    if (data.imagen_procesada1) {
        document.getElementById('binalizada1').src = 'data:image/jpeg;base64,' + data.imagen_procesada1;
    }
    if (data.imagen_procesada2) {
        document.getElementById('binalizada2').src = 'data:image/jpeg;base64,' + data.imagen_procesada2;
    }
    if (data.error) {
        alert('Error: ' + data.error);
    }
    })
    .catch(error => console.error('Error al enviar las imágenes:', error));
}

let isLocked1 = false;
    let isLocked2 = false;
    
    function toggleLock(cropper) {
        if (cropper === cropper1) {
            isLocked1 = !isLocked1;  
            if (isLocked1) {
                cropper1.disable();  
                alert("Edición de Huella 1 bloqueada.");
            } else {
                cropper1.enable();  
                alert("Edición de Huella 1 desbloqueada.");
            }
        } else if (cropper === cropper2) {
            isLocked2 = !isLocked2;  
            if (isLocked2) {
                cropper2.disable();
                alert("Edición de Huella 2 bloqueada.");
            } else {
                cropper2.enable();
                alert("Edición de Huella 2 desbloqueada.");
            }
        }
    }

function showFilteredImages() {
    var croppedImage1 = cropper1.getCroppedCanvas();
    var croppedImage2 = cropper2.getCroppedCanvas();
    document.getElementById('filtered-image1').src = croppedImage1.toDataURL();
    document.getElementById('filtered-image2').src = croppedImage2.toDataURL();
    document.getElementById('filter-section').style.display = 'block';
}

function updateFilter(imageNumber) {
    var brightness = document.getElementById('brightness' + imageNumber).value;
    var contrast = document.getElementById('contrast' + imageNumber).value;
    var saturation = document.getElementById('saturation' + imageNumber).value;
    var grayscale = document.getElementById('grayscale' + imageNumber).value;
    var sepia = document.getElementById('sepia' + imageNumber).value;
    var invert = document.getElementById('invert' + imageNumber).value;
    var hue = document.getElementById('hue' + imageNumber).value;
    var blur = document.getElementById('blur' + imageNumber).value;

    var combinedFilter = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%) ` +
                        `grayscale(${grayscale}%) sepia(${sepia}%) invert(${invert}%) ` +
                        `hue-rotate(${hue}deg) blur(${blur}px)`;
    document.getElementById('filtered-image' + imageNumber).style.filter = combinedFilter;
}

var cropper1, cropper2;
var image1 = document.getElementById('image1');
cropper1 = new Cropper(image1, {
    autoCropArea: 0.65,
    responsive: true,
    zoomable: true,
    scalable: true,
    movable: true
});
var image2 = document.getElementById('image2');
cropper2 = new Cropper(image2, {
    autoCropArea: 0.65,
    responsive: true,
    zoomable: true,
    scalable: true,
    movable: true
});

function loadImage(input, cropper) {
    var file = input.files[0];
    var reader = new FileReader();
    reader.onload = function (e) {
        var url = e.target.result;
        cropper.replace(url);
    };
    reader.readAsDataURL(file);
}

document.getElementById('inputImage1').addEventListener('change', function (e) {
    loadImage(e.target, cropper1);
});
document.getElementById('inputImage2').addEventListener('change', function (e) {
    loadImage(e.target, cropper2);
});

function setDragMode(cropper, mode) {
    cropper.setDragMode(mode);
}
function zoom(cropper, level) {
    cropper.zoom(level);
}
function rotate(cropper, degree) {
    cropper.rotate(degree);
}
function flip(cropper, direction) {
    cropper.scaleX(direction === 'horizontal' ? -1 : 1);
    cropper.scaleY(direction === 'vertical' ? -1 : 1);
}
function reset(cropper) {
    cropper.reset();
}
function destroy(cropper) {
    cropper.destroy();
}
</script>

<script>
   
let puntosTerminacion1 = [];
let puntosBifurcacion1 = [];
let puntosTerminacion2 = [];
let puntosBifurcacion2 = [];
let puntosCotejo = [];
let pendingDeletion = null;  

let manualSelectionMode = false;
let currentSelectionStep = 0;
let currentImageNumber = 0;
let manualPoints = {};
let tempAxisPoints = {};

function procesarImagenes() {
    const formData = new FormData();
    const img1 = document.getElementById('binalizada1');
    const img2 = document.getElementById('binalizada2');
    if (!img1.complete || !img2.complete) {
        alert("Asegúrate de que ambas imágenes estén completamente cargadas.");
        return;
    }
    const canvasTemp1 = document.createElement('canvas');
    canvasTemp1.width = img1.naturalWidth;
    canvasTemp1.height = img1.naturalHeight;
    const ctxTemp1 = canvasTemp1.getContext('2d');
    ctxTemp1.drawImage(img1, 0, 0, canvasTemp1.width, canvasTemp1.height);
    const dataURL1 = canvasTemp1.toDataURL('image/png');
    const base64Image1 = dataURL1.split(',')[1];
    const canvasTemp2 = document.createElement('canvas');
    canvasTemp2.width = img2.naturalWidth;
    canvasTemp2.height = img2.naturalHeight;
    const ctxTemp2 = canvasTemp2.getContext('2d');
    ctxTemp2.drawImage(img2, 0, 0, canvasTemp2.width, canvasTemp2.height);
    const dataURL2 = canvasTemp2.toDataURL('image/png');
    const base64Image2 = dataURL2.split(',')[1];

    formData.append('imagen1', base64Image1);
    formData.append('imagen2', base64Image2);

    fetch('/procesar_imagenes/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        cargarCanvas('canvasProcesada1', data.imagen_esqueletizada1, data.resultados1, 1);
        cargarCanvas('canvasProcesada2', data.imagen_esqueletizada2, data.resultados2, 2);
    })
    .catch(error => console.error('Error al procesar las imágenes:', error));
}

function cargarCanvas(canvasId, imagenDataURL, resultados, numCanvas) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const img = new Image();
    img.onload = function() {
        canvas.width = 480;
        canvas.height = 480;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const scaleX = canvas.width / img.width;
        const scaleY = canvas.height / img.height;
        const scale = Math.min(scaleX, scaleY);
        const scaledWidth = img.width * scale;
        const scaledHeight = img.height * scale;
        const offsetX = (canvas.width - scaledWidth) / 2;
        const offsetY = (canvas.height - scaledHeight) / 2;
        ctx.drawImage(img, offsetX, offsetY, scaledWidth, scaledHeight);
        canvas.setAttribute('data-img', imagenDataURL);
        canvas.setAttribute('data-scale', scale);
        canvas.setAttribute('data-offsetX', offsetX);
        canvas.setAttribute('data-offsetY', offsetY);
        canvas.setAttribute('data-originalWidth', img.width);
        canvas.setAttribute('data-originalHeight', img.height);
        
        if (numCanvas === 1) {
            puntosTerminacion1 = resultados.terminoX.map((x, index) => ({ x: x, y: resultados.terminoY[index] }));
            puntosBifurcacion1 = resultados.bifurX.map((x, index) => ({ x: x, y: resultados.bifurY[index] }));
        } else if (numCanvas === 2) {
            puntosTerminacion2 = resultados.terminoX.map((x, index) => ({ x: x, y: resultados.terminoY[index] }));
            puntosBifurcacion2 = resultados.bifurX.map((x, index) => ({ x: x, y: resultados.bifurY[index] }));
        }
        dibujarPuntos(canvasId, numCanvas);
    }
    img.src = imagenDataURL;
}

function dibujarPuntos(canvasId, numCanvas) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const scale = parseFloat(canvas.getAttribute('data-scale')) || 1;
    const offsetX = parseFloat(canvas.getAttribute('data-offsetX')) || 0;
    const offsetY = parseFloat(canvas.getAttribute('data-offsetY')) || 0;
    const grosorBorde = 3;

    let puntosTerminacion, puntosBifurcacion;
    if (numCanvas === 1) {
        puntosTerminacion = puntosTerminacion1;
        puntosBifurcacion = puntosBifurcacion1;
    } else {
        puntosTerminacion = puntosTerminacion2;
        puntosBifurcacion = puntosBifurcacion2;
    }

    ctx.strokeStyle = 'red';
    ctx.lineWidth = grosorBorde;
    puntosTerminacion.forEach(p => {
        const scaledX = p.y * scale + offsetX;
        const scaledY = p.x * scale + offsetY;
        ctx.beginPath();
        ctx.arc(scaledX, scaledY, 5, 0, 2 * Math.PI);
        ctx.stroke();
    });

    ctx.strokeStyle = 'blue';
    ctx.lineWidth = grosorBorde;
    puntosBifurcacion.forEach(p => {
        const scaledX = p.y * scale + offsetX;
        const scaledY = p.x * scale + offsetY;
        ctx.beginPath();
        ctx.arc(scaledX, scaledY, 5, 0, 2 * Math.PI);
        ctx.stroke();
    });

    ctx.strokeStyle = 'orange';
    puntosCotejo.forEach(p => {
        if (p.canvasId === canvasId) {
            const scaledX = p.y * scale + offsetX;
            const scaledY = p.x * scale + offsetY;
            ctx.beginPath();
            ctx.arc(scaledX, scaledY, 5, 0, 2 * Math.PI);
            ctx.stroke();
        }
    });
}

function handleCanvasClick(event) {
    const canvas = event.target;
    const canvasId = canvas.id;
    const rect = canvas.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const clickY = event.clientY - rect.top;
    const scale = parseFloat(canvas.getAttribute('data-scale')) || 1;
    const offsetX = parseFloat(canvas.getAttribute('data-offsetX')) || 0;
    const offsetY = parseFloat(canvas.getAttribute('data-offsetY')) || 0;
    const originalClickX = (clickX - offsetX) / scale;
    const originalClickY = (clickY - offsetY) / scale;
    const radioDeteccion = 7 / scale; 

    let puntosTerminacion, puntosBifurcacion;
    if (canvasId === 'canvasProcesada1') {
        puntosTerminacion = puntosTerminacion1;
        puntosBifurcacion = puntosBifurcacion1;
    } else if (canvasId === 'canvasProcesada2') {
        puntosTerminacion = puntosTerminacion2;
        puntosBifurcacion = puntosBifurcacion2;
    }

    let puntoEncontrado = null;
    let tipo = null;
    let indice = -1;
    
    for (let i = 0; i < puntosTerminacion.length; i++) {
        const dist = Math.sqrt(Math.pow(puntosTerminacion[i].y - originalClickX, 2) + Math.pow(puntosTerminacion[i].x - originalClickY, 2));
        if (dist < radioDeteccion) {
            puntoEncontrado = puntosTerminacion[i];
            tipo = 'termino';
            indice = i;
            break;
        }
    }
    if (!puntoEncontrado) {
        for (let i = 0; i < puntosBifurcacion.length; i++) {
            const dist = Math.sqrt(Math.pow(puntosBifurcacion[i].y - originalClickX, 2) + Math.pow(puntosBifurcacion[i].x - originalClickY, 2));
            if (dist < radioDeteccion) {
                puntoEncontrado = puntosBifurcacion[i];
                tipo = 'bifur';
                indice = i;
                break;
            }
        }
    }

    if (puntoEncontrado) {
        pendingDeletion = { canvasId, tipo, indice, x: puntoEncontrado.x, y: puntoEncontrado.y };
        abrirModal();
    } else {
        puntosCotejo.push({ x: originalClickY, y: originalClickX, canvasId });
        redibujarCanvas(canvasId, canvasId === 'canvasProcesada1' ? 1 : 2);
    }
}

function abrirModal() {
    const modal = document.getElementById('deletePointModal');
    modal.style.display = 'block';
}

function cerrarModal() {
    const modal = document.getElementById('deletePointModal');
    modal.style.display = 'none';
    pendingDeletion = null;
}

function confirmarEliminacion() {
    if (!pendingDeletion) return;
    
    const { canvasId, tipo, indice } = pendingDeletion;
    if (canvasId === 'canvasProcesada1') {
        if (tipo === 'termino') {
            puntosTerminacion1.splice(indice, 1);
        } else {
            puntosBifurcacion1.splice(indice, 1);
        }
        redibujarCanvas(canvasId, 1);
    } else if (canvasId === 'canvasProcesada2') {
        if (tipo === 'termino') {
            puntosTerminacion2.splice(indice, 1);
        } else {
            puntosBifurcacion2.splice(indice, 1);
        }
        redibujarCanvas(canvasId, 2);
    }
    cerrarModal();
}

function marcarParaCotejo() {
    if (!pendingDeletion) return;
    const { canvasId, x, y } = pendingDeletion;
    puntosCotejo.push({ x, y, canvasId });
    redibujarCanvas(canvasId, canvasId === 'canvasProcesada1' ? 1 : 2);
    cerrarModal();
}

function eliminarPuntosNoCotejados() {
    const filtrarPuntos = (puntos, canvasId) =>
        puntos.filter(p => puntosCotejo.some(pc => pc.x === p.x && pc.y === p.y && pc.canvasId === canvasId));

    puntosTerminacion1 = filtrarPuntos(puntosTerminacion1, 'canvasProcesada1');
    puntosBifurcacion1 = filtrarPuntos(puntosBifurcacion1, 'canvasProcesada1');
    puntosTerminacion2 = filtrarPuntos(puntosTerminacion2, 'canvasProcesada2');
    puntosBifurcacion2 = filtrarPuntos(puntosBifurcacion2, 'canvasProcesada2');

    redibujarCanvas('canvasProcesada1', 1);
    redibujarCanvas('canvasProcesada2', 2);
}

function redibujarCanvas(canvasId, numCanvas) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const imagenDataURL = canvas.getAttribute('data-img');
    if (!imagenDataURL) return;
    
    const img = new Image();
    
    let imageLoadTimeout = setTimeout(() => {
        console.log("[v0] Image load timeout for canvas:", canvasId);
        return;
    }, 5000);
    
    img.onload = function() {
        clearTimeout(imageLoadTimeout);
        const scale = parseFloat(canvas.getAttribute('data-scale')) || 1;
        const offsetX = parseFloat(canvas.getAttribute('data-offsetX')) || 0;
        const offsetY = parseFloat(canvas.getAttribute('data-offsetY')) || 0;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const scaledWidth = img.width * scale;
        const scaledHeight = img.height * scale;
        ctx.drawImage(img, offsetX, offsetY, scaledWidth, scaledHeight);
        
        dibujarPuntos(canvasId, numCanvas);
    }
    
    img.onerror = function() {
        clearTimeout(imageLoadTimeout);
        console.log("[v0] Error loading image for canvas:", canvasId);
    }
    
    img.src = imagenDataURL;
}

function handleManualPointSelection(event) {
    if (event.target.dataset.processing === 'true') {
        return;
    }
    event.target.dataset.processing = 'true';
    
    const canvas = event.target;
    const rect = canvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    
    const ctx = canvas.getContext('2d');
    
    if (currentSelectionStep === 0) {
        tempAxisPoints.x1 = { x, y };
        ctx.fillStyle = 'yellow';
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, 2 * Math.PI);
        ctx.fill();
        
        currentSelectionStep = 1;
        canvas.removeEventListener('click', handleManualPointSelection);
        delete canvas.dataset.processing;
        mostrarModalSeleccion("Seleccione el segundo punto X2 para completar el eje X");
        
    } else if (currentSelectionStep === 1) {
        tempAxisPoints.x2 = { x, y };
        ctx.fillStyle = 'yellow';
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, 2 * Math.PI);
        ctx.fill();
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(tempAxisPoints.x1.x, tempAxisPoints.x1.y);
        ctx.lineTo(tempAxisPoints.x2.x, tempAxisPoints.x2.y);
        ctx.stroke();
        
        currentSelectionStep = 2;
        canvas.removeEventListener('click', handleManualPointSelection);
        delete canvas.dataset.processing;
        mostrarModalSeleccion("Seleccione el punto Y para dibujar el eje Y perpendicular");
        
    } else if (currentSelectionStep === 2) {
        tempAxisPoints.y1 = { x, y };
        ctx.fillStyle = 'yellow';
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, 2 * Math.PI);
        ctx.fill();
        const xAxisVector = {
            x: tempAxisPoints.x2.x - tempAxisPoints.x1.x,
            y: tempAxisPoints.x2.y - tempAxisPoints.x1.y
        };
        
        const vectorLength = Math.sqrt(xAxisVector.x * xAxisVector.x + xAxisVector.y * xAxisVector.y);
        if (vectorLength === 0) {
            alert("Los puntos X1 y X2 no pueden ser el mismo punto");
            delete canvas.dataset.processing;
            return;
        }
        
        const yAxisVector = {
            x: -xAxisVector.y,
            y: xAxisVector.x
        };
        
        const length = Math.sqrt(yAxisVector.x * yAxisVector.x + yAxisVector.y * yAxisVector.y);
        const scale = 100; 
        yAxisVector.x = (yAxisVector.x / length) * scale;
        yAxisVector.y = (yAxisVector.y / length) * scale;
        
        ctx.strokeStyle = 'blue';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x + yAxisVector.x, y + yAxisVector.y);
        ctx.stroke();
        
        if (!manualPoints[currentImageNumber]) {
            manualPoints[currentImageNumber] = {};
        }
        manualPoints[currentImageNumber].origin = tempAxisPoints.y1;
        manualPoints[currentImageNumber].xAxis = xAxisVector;
        manualPoints[currentImageNumber].yAxis = yAxisVector;
        canvas.removeEventListener('click', handleManualPointSelection);
        delete canvas.dataset.processing;
        manualSelectionMode = false;
        actualizarTablaConNuevoSistema(currentImageNumber);
    }
}

function dibujarPlanoCartesiano(canvasOriginalId, canvasPlanoId, canvasPuroId) {
    const puntos = puntosCotejo.filter(p => p.canvasId === canvasOriginalId);
    if (puntos.length < 2) {
        alert("Se necesitan al menos 2 puntos de cotejo para definir el plano.");
        return;
    }

    let pLeft = puntos.reduce((prev, curr) => (curr.y < prev.y ? curr : prev));
    let pRight = puntos.reduce((prev, curr) => (curr.y > prev.y ? curr : prev));

    const X1 = pLeft.y, Y1 = pLeft.x;
    const X2 = pRight.y, Y2 = pRight.x;
    const dx = X2 - X1, dy = Y2 - Y1;
    const norm = Math.sqrt(dx * dx + dy * dy);
    
    if (norm === 0 || !isFinite(norm)) { 
        alert("No se puede definir la línea base con estos puntos."); 
        return; 
    }

    const ux = dx / norm, uy = dy / norm;
    const vx = -uy, vy = ux;

    const canvasOriginal = document.getElementById(canvasOriginalId);
    const imagenDataURL = canvasOriginal.getAttribute('data-img');
    if (!imagenDataURL) return;
    
    const canvasPlano = document.getElementById(canvasPlanoId);
    const canvasPuro = document.getElementById(canvasPuroId);
    const ctxPlano = canvasPlano.getContext('2d');
    const ctxPuro = canvasPuro.getContext('2d');
    
    const img = new Image();
    
    let imageLoadTimeout = setTimeout(() => {
        console.log("[v0] Image load timeout for cartesian plane");
        return;
    }, 5000);
    
    img.onload = function() {
        clearTimeout(imageLoadTimeout);
        canvasPlano.width = 480;
        canvasPlano.height = 480;
        canvasPuro.width = 480;
        canvasPuro.height = 480;
        canvasPlano.setAttribute('data-img', imagenDataURL);
        const scaleX = canvasPlano.width / img.width;
        const scaleY = canvasPlano.height / img.height;
        const scale = Math.min(scaleX, scaleY);
        
        if (!isFinite(scale) || scale <= 0) {
            console.log("[v0] Invalid scale calculated");
            return;
        }
        
        const scaledWidth = img.width * scale;
        const scaledHeight = img.height * scale;
        const offsetX = (canvasPlano.width - scaledWidth) / 2;
        const offsetY = (canvasPlano.height - scaledHeight) / 2;
        ctxPlano.drawImage(img, offsetX, offsetY, scaledWidth, scaledHeight);
        ctxPuro.fillStyle = 'white';
        ctxPuro.fillRect(0, 0, canvasPuro.width, canvasPuro.height);
        const originX = X1 * scale + offsetX;
        const originY = Y1 * scale + offsetY;

        if (!isFinite(originX) || !isFinite(originY)) {
            console.log("[v0] Invalid origin coordinates");
            return;
        }

        [ctxPlano, ctxPuro].forEach(ctx => {
            ctx.strokeStyle = 'green';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, originY);
            ctx.lineTo(ctx.canvas.width, originY);
            ctx.stroke();
            ctx.strokeStyle = 'purple';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(originX, 0);
            ctx.lineTo(originX, ctx.canvas.height);
            ctx.stroke();
        });

        let puntosConAngulo = [];
        puntos.forEach(p => {
            const Xp = p.y, Yp = p.x;
            const dxp = Xp - X1, dyp = Yp - Y1;
            const Xprime = dxp * ux + dyp * uy, Yprime = dxp * vx + dyp * vy;
            let angulo = Math.atan2(Yprime, Xprime);
            if (angulo < 0) { angulo += 2 * Math.PI; }
            const distancia = Math.sqrt(Xprime * Xprime + Yprime * Yprime);
            
            if (isFinite(angulo) && isFinite(distancia)) {
                puntosConAngulo.push({ p, angulo, distancia, Xprime, Yprime });
            }
        });

        let puntosEtiquetados = puntosConAngulo.sort((a, b) => a.angulo - b.angulo);
        const alfabeto = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        puntosEtiquetados = puntosEtiquetados.map((item, index) => {
            return { ...item, letra: alfabeto[index] || '?' };
        });

        ctxPlano.strokeStyle = 'orange';
        ctxPlano.lineWidth = 3;
        puntosEtiquetados.forEach(item => {
            const pt = item.p;
            const scaledX = pt.y * scale + offsetX;
            const scaledY = pt.x * scale + offsetY;
            ctxPlano.beginPath();
            ctxPlano.arc(scaledX, scaledY, 6, 0, 2 * Math.PI);
            ctxPlano.stroke();
        });

        ctxPlano.font = "16px Arial";
        ctxPlano.fillStyle = 'black';
        ctxPlano.strokeStyle = 'white';
        ctxPlano.lineWidth = 3;
        puntosEtiquetados.forEach(item => {
            const scaledX = item.p.y * scale + offsetX;
            const scaledY = item.p.x * scale + offsetY;
            ctxPlano.strokeText(item.letra, scaledX + 10, scaledY - 10);
            ctxPlano.fillText(item.letra, scaledX + 10, scaledY - 10);
        });
        ctxPuro.fillStyle = 'red';
        ctxPuro.beginPath();
        ctxPuro.arc(originX, originY, 8, 0, 2 * Math.PI);
        ctxPuro.fill();
        puntosEtiquetados.forEach(item => {
            const scaledX = item.p.y * scale + offsetX;
            const scaledY = item.p.x * scale + offsetY;
            ctxPuro.strokeStyle = 'blue';
            ctxPuro.lineWidth = 2;
            ctxPuro.beginPath();
            ctxPuro.moveTo(originX, originY);
            ctxPuro.lineTo(scaledX, scaledY);
            ctxPuro.stroke();
            ctxPuro.fillStyle = 'orange';
            ctxPuro.beginPath();
            ctxPuro.arc(scaledX, scaledY, 6, 0, 2 * Math.PI);
            ctxPuro.fill();
            ctxPuro.font = "14px Arial";
            ctxPuro.fillStyle = 'black';
            ctxPuro.fillText(item.letra, scaledX + 10, scaledY - 10);
        });

        actualizarTabla(puntosEtiquetados, canvasOriginalId);
    };
    
    img.onerror = function() {
        clearTimeout(imageLoadTimeout);
        console.log("[v0] Error loading image for cartesian plane");
    };
    
    img.src = imagenDataURL;
}

function actualizarTabla(puntosEtiquetados, canvasId) {
    const huellaNum = canvasId === 'canvasProcesada1' ? '1' : '2';
    const tableBodyId = `pointsTableBody${huellaNum}`;
    const tableBody = document.getElementById(tableBodyId);
    
    tableBody.innerHTML = '';
    
    puntosEtiquetados.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.letra}</td>
            <td>${item.Xprime.toFixed(2)}</td>
            <td>${item.Yprime.toFixed(2)}</td>
            <td>${item.distancia.toFixed(2)}</td>
            <td>${(item.angulo * 180 / Math.PI).toFixed(2)}</td>
        `;
        tableBody.appendChild(row);
    });
}

document.getElementById('mostrarPlanos').addEventListener('click', function () {
    document.getElementById('pointsTableBody1').innerHTML = '';
    document.getElementById('pointsTableBody2').innerHTML = '';
    document.getElementById('cartesianSection').style.display = 'block';
    dibujarPlanoCartesiano('canvasProcesada1', 'canvasPlano1', 'canvasPuro1');
    dibujarPlanoCartesiano('canvasProcesada2', 'canvasPlano2', 'canvasPuro2');
    document.getElementById('cartesianSection').scrollIntoView({ behavior: 'smooth' });
});

document.getElementById('eliminarNoCotejados').addEventListener('click', function () {
    eliminarPuntosNoCotejados();
});

document.getElementById('confirmDelete').addEventListener('click', function () {
    confirmarEliminacion();
});

document.getElementById('cancelDelete').addEventListener('click', function () {
    cerrarModal();
});

document.getElementById('marcarCotejo').addEventListener('click', function () {
    marcarParaCotejo();
});

document.getElementById('canvasProcesada1').addEventListener('click', function (event) {
    handleCanvasClick(event);
});

document.getElementById('canvasProcesada2').addEventListener('click', function (event) {
    handleCanvasClick(event);
});

function iniciarSeleccionManual(imageNumber) {
    currentImageNumber = imageNumber;
    currentSelectionStep = 0;
    manualSelectionMode = true;
    const canvasId = `canvasPlano${imageNumber}`;
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const img = new Image();
    img.onload = function() {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.addEventListener('click', handleManualPointSelection);
        mostrarModalSeleccion("Seleccione el primer punto X1 para dibujar el eje X de la imagen");
    };
    img.src = canvas.getAttribute('data-img');
}

function mostrarModalSeleccion(message) {
    const modal = document.getElementById('manualCoordinateModal');
    const modalMessage = document.getElementById('modalMessage');
    modalMessage.textContent = message;
    modal.style.display = 'block';
}

function cerrarModalSeleccion() {
    const modal = document.getElementById('manualCoordinateModal');
    modal.style.display = 'none';
}

document.getElementById('cancelManualSelection').addEventListener('click', function () {
    cerrarModalSeleccion();
    const canvasId = `canvasPlano${currentImageNumber}`;
    const canvas = document.getElementById(canvasId);
    canvas.removeEventListener('click', handleManualPointSelection);
    manualSelectionMode = false;
});

function actualizarTablaConNuevoSistema(imageNumber) {
    const canvasId = `canvasProcesada${imageNumber}`;
    const puntos = puntosCotejo.filter(p => p.canvasId === canvasId);
    
    if (!manualPoints[imageNumber] || !manualPoints[imageNumber].origin || !manualPoints[imageNumber].xAxis || !manualPoints[imageNumber].yAxis) {
        alert("Sistema de coordenadas manual no definido.");
        return;
    }
    
    const origin = manualPoints[imageNumber].origin;
    const xAxis = manualPoints[imageNumber].xAxis;
    const yAxis = manualPoints[imageNumber].yAxis;

    let puntosConAngulo = [];
    puntos.forEach(p => {
        const dxp = p.y - origin.x;
        const dyp = p.x - origin.y;
        const Xprime = dxp * xAxis.x + dyp * xAxis.y;
        const Yprime = dxp * yAxis.x + dyp * yAxis.y;
        let angulo = Math.atan2(Yprime, Xprime);
        if (angulo < 0) { angulo += 2 * Math.PI; }
        const distancia = Math.sqrt(Xprime * Xprime + Yprime * Yprime);
        
        if (isFinite(angulo) && isFinite(distancia)) {
            puntosConAngulo.push({ p, angulo, distancia, Xprime, Yprime });
        }
    });
    
    let puntosEtiquetados = puntosConAngulo.sort((a, b) => a.angulo - b.angulo);
    const alfabeto = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    puntosEtiquetados = puntosEtiquetados.map((item, index) => {
        return { ...item, letra: alfabeto[index] || '?' };
    });
    
    const huellaNum = imageNumber === 1 ? '1' : '2';
    const tableBodyId = `pointsTableBody${huellaNum}`;
    const tableBody = document.getElementById(tableBodyId);
    
    tableBody.innerHTML = '';
    
    puntosEtiquetados.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.letra}</td>
            <td>${item.Xprime.toFixed(2)}</td>
            <td>${item.Yprime.toFixed(2)}</td>
            <td>${item.distancia.toFixed(2)}</td>
            <td>${(item.angulo * 180 / Math.PI).toFixed(2)}</td>
        `;
        tableBody.appendChild(row);
    });
}
</script>

{% endblock %}
{% endblock %}
