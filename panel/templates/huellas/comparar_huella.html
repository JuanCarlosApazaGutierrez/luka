{% extends 'index_master.html' %}

{% block content %}
<style>
    .filter-control {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      .filter-control label {
        width: 110px; /* ancho fijo para que queden alineados */
        text-align: right;
        margin-right: 10px;
      }
      .filter-controls {
        max-width: 350px;
        margin: 0 auto;
      }
    .filtered-image-container {
        width: 500px;  /* Ancho fijo, puedes ajustarlo */
        height: 500px; /* Alto fijo, puedes ajustarlo */
        border: 1px solid #ddd;
        margin: auto;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f0f0f0;
    }
    
    .filtered-image-container img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* Mantiene la proporción de la imagen */
    }
   
      
      
</style>
<div class="right_col" role="main">
    <h1>Cotejo de Huellas Dactilares</h1>
    <div class="col-md-12 col-sm-12 ">
        <div class="x_panel">
            <div class="x_title">
                <h2>AREA #1<small>Editar Imagen</small></h2>
                <div class="d-flex justify-content-end">
                    <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="row">
                    <div class="container cropper">
                        <div class="row text-center">
                            <div class="col-md-6">
                                <h2>Huella #1</h2>
                            </div>
                            <div class="col-md-6">
                                <h2>Huella #2</h2>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="img-container">
                                    <img id="image1" src="../media/inicio.png" alt="Picture 1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="img-container">
                                    <img id="image2" src="../media/inicio.png" alt="Picture 2">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 docs-buttons text-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="move" title="Move" onclick="setDragMode(cropper1, 'move')">
                                        <span class="fa fa-arrows"></span>
                                    </button>
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="crop" title="Crop" onclick="setDragMode(cropper1, 'crop')">
                                        <span class="fa fa-crop"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="0.1" title="Zoom In" onclick="zoom(cropper1, 0.1)">
                                        <span class="fa fa-search-plus"></span>
                                    </button>
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="-0.1" title="Zoom Out" onclick="zoom(cropper1, -0.1)">
                                        <span class="fa fa-search-minus"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="1" title="Rotate 1°" onclick="rotate(cropper1, 1)">
                                        <span class="fa fa-rotate-right"></span>
                                    </button>
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="-1" title="Rotate -1°" onclick="rotate(cropper1, -1)">
                                        <span class="fa fa-rotate-left"></span>
                                    </button>
                                    
                                </div>
                                <div class="btn-group">
                                    
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="horizontal" title="Flip Horizontal" onclick="flip(cropper1, 'horizontal')">
                                        <span class="fa fa-arrow-left"></span>
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="vertical" title="Flip Vertical" onclick="flip(cropper1, 'vertical')">
                                        <span class="fa fa-arrow-up"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-danger" data-method="reset" title="Reset" onclick="reset(cropper1)">
                                        <span class="fa fa-refresh"></span> 
                                    </button>
                                    
                                    
                                </div>
                                <div class="btn-group">
                                    
                                    <label class="btn btn-success btn-upload" for="inputImage1" title="Upload image file">
                                        <input type="file" class="sr-only" id="inputImage1" name="file" accept="image/*"> 
                                        <span class="fa fa-upload"></span> Huella 1
                                    </label>
                                    
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-dark" title="Bloquear Edición" onclick="toggleLock(cropper1)">
                                        <span class="fa fa-lock"></span> Bloquear Edición
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 docs-buttons text-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="move" title="Move" onclick="setDragMode(cropper2, 'move')">
                                        <span class="fa fa-arrows"></span>
                                    </button>
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="crop" title="Crop" onclick="setDragMode(cropper2, 'crop')">
                                        <span class="fa fa-crop"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="0.1" title="Zoom In" onclick="zoom(cropper2, 0.1)">
                                        <span class="fa fa-search-plus"></span>
                                    </button>
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="-0.1" title="Zoom Out" onclick="zoom(cropper2, -0.1)">
                                        <span class="fa fa-search-minus"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="1" title="Rotate 1°" onclick="rotate(cropper2, 1)">
                                        <span class="fa fa-rotate-right"></span>
                                    </button>
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="-1" title="Rotate -1°" onclick="rotate(cropper2, -1)">
                                        <span class="fa fa-rotate-left"></span>
                                    </button>
                                    
                                </div>
                                <div class="btn-group">
                                    
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="horizontal" title="Flip Horizontal" onclick="flip(cropper2, 'horizontal')">
                                        <span class="fa fa-arrow-left"></span>
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="vertical" title="Flip Vertical" onclick="flip(cropper2, 'vertical')">
                                        <span class="fa fa-arrow-up"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-danger" data-method="reset" title="Reset" onclick="reset(cropper2)">
                                        <span class="fa fa-refresh"></span>
                                    </button>
                                    
                                
                                </div>
                                <div class="btn-group">
                                    
                                    <label class="btn btn-success btn-upload" for="inputImage2" title="Upload image file">
                                        <input type="file" class="sr-only" id="inputImage2" name="file" accept="image/*"> 
                                        <span class="fa fa-upload"></span> Huella 2
                                    </label>
                                
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-dark" title="Bloquear Edición" onclick="toggleLock(cropper2)">
                                        <span class="fa fa-lock"></span> Bloquear Edición
                                    </button>
                                </div>
                                
                            </div>
                        </div>

                        <br/>
                        <hr/>
                        <div class="row">
                            <div class="col-md-12 docs-buttons text-center">
                                <button type="button"  class="btn btn-secondary">
                                    <span class="fa fa-fast-forward"></span> Omitir (Filtrado Automático)
                                </button>
                                <button type="button" class="btn btn-primary" onclick="showFilteredImages()">
                                    <span class="fa fa-filter"></span> Enviar a Filtrado
                                </button>
                            </div>
                        </div>
                        <div id="filter-section" style="display: none; margin-top: 20px;">
                            <div class="row text-center">
                              <!-- Contenedor para Huella #1 -->
                              <div class="col-md-6">
                                <h3>Huella #1 (Filtrada)</h3>
                                <div class="filtered-image-container">
                                    <img id="filtered-image1" src="" alt="Imagen Filtrada 1" style="max-width:100%;">
                                  </div>
                                <div class="filter-controls mt-2">
                                  <!-- Controles de filtro para la imagen 1 -->
                                  <div class="filter-control">
                                    <label for="brightness1">Brillo:</label>
                                    <input type="range" id="brightness1" min="0" max="200" value="100" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="contrast1">Contraste:</label>
                                    <input type="range" id="contrast1" min="0" max="200" value="100" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="saturation1">Saturación:</label>
                                    <input type="range" id="saturation1" min="0" max="200" value="100" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="grayscale1">Escala de grises:</label>
                                    <input type="range" id="grayscale1" min="0" max="100" value="0" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="sepia1">Sepia:</label>
                                    <input type="range" id="sepia1" min="0" max="100" value="0" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="invert1">Invertir:</label>
                                    <input type="range" id="invert1" min="0" max="100" value="0" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="hue1">Rotar Matiz:</label>
                                    <input type="range" id="hue1" min="0" max="360" value="0" onchange="updateFilter(1)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="blur1">Desenfoque:</label>
                                    <input type="range" id="blur1" min="0" max="10" value="0" step="0.1" onchange="updateFilter(1)">
                                  </div>
                                </div>
                              </div>
                              <!-- Contenedor para Huella #2 -->
                              <div class="col-md-6">
                                <h3>Huella #2 (Filtrada)</h3>
                                <div class="filtered-image-container">
                                    <img id="filtered-image2" src="" alt="Imagen Filtrada 2" style="max-width:100%;">
                                  </div>
                                <div class="filter-controls mt-2">
                                  <!-- Controles de filtro para la imagen 2 -->
                                  <div class="filter-control">
                                    <label for="brightness2">Brillo:</label>
                                    <input type="range" id="brightness2" min="0" max="200" value="100" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="contrast2">Contraste:</label>
                                    <input type="range" id="contrast2" min="0" max="200" value="100" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="saturation2">Saturación:</label>
                                    <input type="range" id="saturation2" min="0" max="200" value="100" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="grayscale2">Escala de grises:</label>
                                    <input type="range" id="grayscale2" min="0" max="100" value="0" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="sepia2">Sepia:</label>
                                    <input type="range" id="sepia2" min="0" max="100" value="0" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="invert2">Invertir:</label>
                                    <input type="range" id="invert2" min="0" max="100" value="0" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="hue2">Rotar Matiz:</label>
                                    <input type="range" id="hue2" min="0" max="360" value="0" onchange="updateFilter(2)">
                                  </div>
                                  <div class="filter-control">
                                    <label for="blur2">Desenfoque:</label>
                                    <input type="range" id="blur2" min="0" max="10" value="0" step="0.1" onchange="updateFilter(2)">
                                  </div>
                                </div>
                              </div>
                            </div>
                            <br/>
                            <hr/>
                            <div class="row">
                              <div class="col-md-12 docs-buttons text-center">
                                <button type="button" class="btn btn-primary" onclick="enviarImagenFiltrada()">
                                  <span class="fa fa-save"></span> Guardar y Enviar a Fase de Binalizado
                                </button>
                              </div>
                            </div>
                        </div>
                          
        
                    </div> 
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-12 col-sm-12 ">
        <div class="x_panel">
          <div class="x_title">
            <h2>AREA #2 <small>Editar Imagen</small></h2>
            <div class="d-flex justify-content-end">
              <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
            </div>
            <div class="clearfix"></div>
          </div>
          <div class="x_content">
            <div class="row">
              <div class="container cropper">
                <div class="row text-center">
                  <div class="col-md-6">
                    <h2>Huella Binalizada #1</h2>
                  </div>
                  <div class="col-md-6">
                    <h2>Huella Binalizada #2</h2>
                  </div>
                </div>
            </div>
        </div>
    </div>

               <!-- HTML para cargar y procesar imágenes -->
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <div class="filtered-image-container">
                        <img id="binalizada1" src="../media/inicio.png" alt="Huella Binalizada 1">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filtered-image-container">
                        <img id="binalizada2" src="../media/inicio.png" alt="Huella Binalizada 2">
                    </div>
                </div>
            </div>
            <br/>
            <div class="text-center">
                <button type="button" class="btn btn-primary" onclick="procesarImagenes()">
                    <span class="fa fa-filter"></span> Mostrar puntos
                </button>
            </div>
            <hr/>
            <!-- Área para mostrar las imágenes esqueletizadas -->
            <div class="row">
                <div class="col-md-6">
                    <img id="imagen_esqueletizada1" src="" alt="Imagen Esqueletizada 1">
                </div>
                <div class="col-md-6">
                    <img id="imagen_esqueletizada2" src="" alt="Imagen Esqueletizada 2">
                </div>
            </div>
            <br/>
            <!-- Tabla de resultados -->
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Tipo de Minucias</th>
                        <th>Coordenadas X</th>
                        <th>Coordenadas Y</th>
                    </tr>
                </thead>
                <tbody id="resultados"></tbody>
            </table>
        </div>
    </div>
</div>

        
        
 
                        
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.js"></script>
<script>

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
    let cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        let cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
        }
    }
    }
    return cookieValue;
}


function getFilteredCanvas(imageElement) {

    if (!imageElement.complete) {
    alert("La imagen no está completamente cargada.");
    return null;
    }
    const canvas = document.createElement('canvas');
    canvas.width = imageElement.naturalWidth;
    canvas.height = imageElement.naturalHeight;
    const ctx = canvas.getContext('2d');
    ctx.filter = imageElement.style.filter || '';
    ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);
    return canvas;
}

function enviarImagenFiltrada() {
    const csrfToken = getCookie('csrftoken');
    let imgEl1 = document.getElementById('filtered-image1');
    let imgEl2 = document.getElementById('filtered-image2');

    if (!imgEl1.src || !imgEl2.src) {
    alert('No se han aplicado filtros a ambas imágenes.');
    return;
    }

    let canvas1 = getFilteredCanvas(imgEl1);
    let canvas2 = getFilteredCanvas(imgEl2);

    if (!canvas1 || !canvas2) {
    alert("Error al procesar las imágenes filtradas.");
    return;
    }
    
    function dataURLToBlob(dataURL) {
    const parts = dataURL.split(',');
    const byteString = atob(parts[1]);
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ia], { type: 'image/jpeg' });
    }

    let dataURL1 = canvas1.toDataURL('image/jpeg');
    let dataURL2 = canvas2.toDataURL('image/jpeg');

    let blob1 = dataURLToBlob(dataURL1);
    let blob2 = dataURLToBlob(dataURL2);

    let formData = new FormData();
    formData.append('imagen', blob1, 'imagen1.jpg');
    formData.append('imagen2', blob2, 'imagen2.jpg');

    fetch('/binalizado_automatico/', {
    method: 'POST',
    body: formData,
    headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
    }
    })
    .then(response => response.json())
    .then(data => {
    if (data.imagen_procesada1) {
        document.getElementById('binalizada1').src = 'data:image/jpeg;base64,' + data.imagen_procesada1;
    }
    if (data.imagen_procesada2) {
        document.getElementById('binalizada2').src = 'data:image/jpeg;base64,' + data.imagen_procesada2;
    }
    if (data.error) {
        alert('Error: ' + data.error);
    }
    })
    .catch(error => console.error('Error al enviar las imágenes:', error));
}

let isLocked1 = false;
    let isLocked2 = false;
    
    function toggleLock(cropper) {
        if (cropper === cropper1) {
            isLocked1 = !isLocked1;  
            if (isLocked1) {
                cropper1.disable();  
                alert("Edición de Huella 1 bloqueada.");
            } else {
                cropper1.enable();  
                alert("Edición de Huella 1 desbloqueada.");
            }
        } else if (cropper === cropper2) {
            isLocked2 = !isLocked2;  
            if (isLocked2) {
                cropper2.disable();
                alert("Edición de Huella 2 bloqueada.");
            } else {
                cropper2.enable();
                alert("Edición de Huella 2 desbloqueada.");
            }
        }
    }

function showFilteredImages() {
    var croppedImage1 = cropper1.getCroppedCanvas();
    var croppedImage2 = cropper2.getCroppedCanvas();
    document.getElementById('filtered-image1').src = croppedImage1.toDataURL();
    document.getElementById('filtered-image2').src = croppedImage2.toDataURL();
    document.getElementById('filter-section').style.display = 'block';
}

function updateFilter(imageNumber) {
    var brightness = document.getElementById('brightness' + imageNumber).value;
    var contrast = document.getElementById('contrast' + imageNumber).value;
    var saturation = document.getElementById('saturation' + imageNumber).value;
    var grayscale = document.getElementById('grayscale' + imageNumber).value;
    var sepia = document.getElementById('sepia' + imageNumber).value;
    var invert = document.getElementById('invert' + imageNumber).value;
    var hue = document.getElementById('hue' + imageNumber).value;
    var blur = document.getElementById('blur' + imageNumber).value;

    var combinedFilter = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%) ` +
                        `grayscale(${grayscale}%) sepia(${sepia}%) invert(${invert}%) ` +
                        `hue-rotate(${hue}deg) blur(${blur}px)`;
    document.getElementById('filtered-image' + imageNumber).style.filter = combinedFilter;
}

var cropper1, cropper2;
var image1 = document.getElementById('image1');
cropper1 = new Cropper(image1, {
    autoCropArea: 0.65,
    responsive: true,
    zoomable: true,
    scalable: true,
    movable: true
});
var image2 = document.getElementById('image2');
cropper2 = new Cropper(image2, {
    autoCropArea: 0.65,
    responsive: true,
    zoomable: true,
    scalable: true,
    movable: true
});

function loadImage(input, cropper) {
    var file = input.files[0];
    var reader = new FileReader();
    reader.onload = function (e) {
        var url = e.target.result;
        cropper.replace(url);
    };
    reader.readAsDataURL(file);
}

document.getElementById('inputImage1').addEventListener('change', function (e) {
    loadImage(e.target, cropper1);
});
document.getElementById('inputImage2').addEventListener('change', function (e) {
    loadImage(e.target, cropper2);
});

function setDragMode(cropper, mode) {
    cropper.setDragMode(mode);
}
function zoom(cropper, level) {
    cropper.zoom(level);
}
function rotate(cropper, degree) {
    cropper.rotate(degree);
}
function flip(cropper, direction) {
    cropper.scaleX(direction === 'horizontal' ? -1 : 1);
    cropper.scaleY(direction === 'vertical' ? -1 : 1);
}
function reset(cropper) {
    cropper.reset();
}
function destroy(cropper) {
    cropper.destroy();
}
</script>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            let cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                // Busca la cookie que empieza con el nombre dado
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function procesarImagenes() {
        const formData = new FormData();
    
        // Obtener los elementos de imagen
        const img1 = document.getElementById('binalizada1');
        const img2 = document.getElementById('binalizada2');
    
        // Verificar que las imágenes estén cargadas
        if (!img1.complete || !img2.complete) {
            alert("Asegúrate de que ambas imágenes estén completamente cargadas.");
            return;
        }
    
        // Crear canvas para la primera imagen y extraer su dataURL
        const canvas1 = document.createElement('canvas');
        canvas1.width = img1.naturalWidth;
        canvas1.height = img1.naturalHeight;
        const ctx1 = canvas1.getContext('2d');
        ctx1.drawImage(img1, 0, 0, canvas1.width, canvas1.height);
        const dataURL1 = canvas1.toDataURL('image/png');
        
        // Crear canvas para la segunda imagen y extraer su dataURL
        const canvas2 = document.createElement('canvas');
        canvas2.width = img2.naturalWidth;
        canvas2.height = img2.naturalHeight;
        const ctx2 = canvas2.getContext('2d');
        ctx2.drawImage(img2, 0, 0, canvas2.width, canvas2.height);
        const dataURL2 = canvas2.toDataURL('image/png');
        
        // Extraer la parte base64 (removiendo el prefijo data:image/png;base64,)
        const base64Image1 = dataURL1.split(',')[1];
        const base64Image2 = dataURL2.split(',')[1];
    
        // Agregar las imágenes en base64 al FormData
        formData.append('imagen1', base64Image1);
        formData.append('imagen2', base64Image2);
    
        // Enviar los datos al servidor
        fetch('/procesar_imagenes/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            // Actualizar las imágenes procesadas en el DOM
            document.getElementById('imagen_esqueletizada1').src = data.imagen_esqueletizada1;
            document.getElementById('imagen_esqueletizada2').src = data.imagen_esqueletizada2;
    
            // Actualizar la tabla de resultados
            const tabla = document.getElementById('resultados');
            tabla.innerHTML = '';
            data.resultados.forEach(resultado => {
                const fila = `<tr>
                                <td>${resultado.tipo}</td>
                                <td>${resultado.x}</td>
                                <td>${resultado.y}</td>
                              </tr>`;
                tabla.innerHTML += fila;
            });
        })
        .catch(error => console.error('Error al procesar las imágenes:', error));
    }
    
</script>

{% endblock %}
{% endblock %}