{% extends 'index_master.html' %}

{% block content %}
<style>
    .filtered-image-container {
        width: 500px;  /* Ancho fijo, puedes ajustarlo */
        height: 500px; /* Alto fijo, puedes ajustarlo */
        border: 1px solid #ddd;
        margin: auto;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f0f0f0;
    }
    
    .filtered-image-container img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* Mantiene la proporción de la imagen */
    }
    
</style>
<div class="right_col" role="main">
    <h1>Cotejo de Huellas Dactilares</h1>
    <div class="col-md-12 col-sm-12 ">
        <div class="x_panel">
            <div class="x_title">
                <h2>AREA #1<small>Editar Imagen</small></h2>
                <div class="d-flex justify-content-end">
                    <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="row">
                    <div class="container cropper">
                        <div class="row text-center">
                            <div class="col-md-6">
                                <h2>Huella #1</h2>
                            </div>
                            <div class="col-md-6">
                                <h2>Huella #2</h2>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="img-container">
                                    <img id="image1" src="../media/inicio.png" alt="Picture 1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="img-container">
                                    <img id="image2" src="../media/inicio.png" alt="Picture 2">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 docs-buttons text-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="move" title="Move" onclick="setDragMode(cropper1, 'move')">
                                        <span class="fa fa-arrows"></span>
                                    </button>
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="crop" title="Crop" onclick="setDragMode(cropper1, 'crop')">
                                        <span class="fa fa-crop"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="0.1" title="Zoom In" onclick="zoom(cropper1, 0.1)">
                                        <span class="fa fa-search-plus"></span>
                                    </button>
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="-0.1" title="Zoom Out" onclick="zoom(cropper1, -0.1)">
                                        <span class="fa fa-search-minus"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="1" title="Rotate 1°" onclick="rotate(cropper1, 1)">
                                        <span class="fa fa-rotate-right"></span>
                                    </button>
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="-1" title="Rotate -1°" onclick="rotate(cropper1, -1)">
                                        <span class="fa fa-rotate-left"></span>
                                    </button>
                                    
                                </div>
                                <div class="btn-group">
                                    
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="horizontal" title="Flip Horizontal" onclick="flip(cropper1, 'horizontal')">
                                        <span class="fa fa-arrow-left"></span>
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="vertical" title="Flip Vertical" onclick="flip(cropper1, 'vertical')">
                                        <span class="fa fa-arrow-up"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-danger" data-method="reset" title="Reset" onclick="reset(cropper1)">
                                        <span class="fa fa-refresh"></span> 
                                    </button>
                                    
                                    
                                </div>
                                <div class="btn-group">
                                    
                                    <label class="btn btn-success btn-upload" for="inputImage1" title="Upload image file">
                                        <input type="file" class="sr-only" id="inputImage1" name="file" accept="image/*"> 
                                        <span class="fa fa-upload"></span> Huella 1
                                    </label>
                                    
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-dark" title="Bloquear Edición" onclick="toggleLock(cropper1)">
                                        <span class="fa fa-lock"></span> Bloquear Edición
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 docs-buttons text-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="move" title="Move" onclick="setDragMode(cropper2, 'move')">
                                        <span class="fa fa-arrows"></span>
                                    </button>
                                    <button type="button" class="btn btn-primary" data-method="setDragMode" data-option="crop" title="Crop" onclick="setDragMode(cropper2, 'crop')">
                                        <span class="fa fa-crop"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="0.1" title="Zoom In" onclick="zoom(cropper2, 0.1)">
                                        <span class="fa fa-search-plus"></span>
                                    </button>
                                    <button type="button" class="btn btn-warning" data-method="zoom" data-option="-0.1" title="Zoom Out" onclick="zoom(cropper2, -0.1)">
                                        <span class="fa fa-search-minus"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="1" title="Rotate 1°" onclick="rotate(cropper2, 1)">
                                        <span class="fa fa-rotate-right"></span>
                                    </button>
                                    <button type="button" class="btn btn-info" data-method="rotate" data-option="-1" title="Rotate -1°" onclick="rotate(cropper2, -1)">
                                        <span class="fa fa-rotate-left"></span>
                                    </button>
                                    
                                </div>
                                <div class="btn-group">
                                    
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="horizontal" title="Flip Horizontal" onclick="flip(cropper2, 'horizontal')">
                                        <span class="fa fa-arrow-left"></span>
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-method="flip" data-option="vertical" title="Flip Vertical" onclick="flip(cropper2, 'vertical')">
                                        <span class="fa fa-arrow-up"></span>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-danger" data-method="reset" title="Reset" onclick="reset(cropper2)">
                                        <span class="fa fa-refresh"></span>
                                    </button>
                                    
                                
                                </div>
                                <div class="btn-group">
                                    
                                    <label class="btn btn-success btn-upload" for="inputImage2" title="Upload image file">
                                        <input type="file" class="sr-only" id="inputImage2" name="file" accept="image/*"> 
                                        <span class="fa fa-upload"></span> Huella 2
                                    </label>
                                
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-dark" title="Bloquear Edición" onclick="toggleLock(cropper2)">
                                        <span class="fa fa-lock"></span> Bloquear Edición
                                    </button>
                                </div>
                                
                            </div>
                        </div>

                        <br/>
                        <hr/>
                        <div class="row">
                            <div class="col-md-12 docs-buttons text-center">
                                <button type="button" class="btn btn-secondary">
                                    <span class="fa fa-fast-forward"></span> Omitir (Filtrado Automático)
                                </button>
                                <button type="button" class="btn btn-primary" onclick="showFilteredImages()">
                                    <span class="fa fa-filter"></span> Enviar a Filtrado
                                </button>
                            </div>
                        </div>

                        <div id="filter-section" style="display: none; margin-top: 20px;">
                            <div class="row text-center">
                              
                                <div class="row">
                                    <!-- Imagen 1 -->
                                    <div class="col-md-6">
                                        <h3>Huella #1 (Filtrada)</h3>
                                        <img id="filtered-image1" src="" alt="Filtered Image 1" style="max-width: 100%; height: auto;">
                                
                                        <div class="filter-controls">
                                            <label>Ecualización de Histograma:</label>
                                            <input type="range" id="histogram-equalization1" min="0" max="100" value="50">
                                
                                            <label>Realce de Contraste:</label>
                                            <input type="range" id="enhance1" min="0" max="100" value="50">
                                
                                            <label>Filtro Mediana:</label>
                                            <input type="range" id="median1" min="1" max="15" value="3">
                                
                                            <label>Filtro Gaussiano:</label>
                                            <input type="range" id="gaussian1" min="1" max="15" value="3">
                                
                                            <label>Umbral:</label>
                                            <input type="range" id="threshold1" min="0" max="255" value="128">
                                
                                            <label>Umbral Adaptativo:</label>
                                            <input type="range" id="adaptive-threshold1" min="1" max="15" value="3">
                                
                                            <label>Dilatación:</label>
                                            <input type="range" id="dilation1" min="1" max="15" value="3">
                                
                                            <label>Erosión:</label>
                                            <input type="range" id="erosion1" min="1" max="15" value="3">
                                
                                            <label>Apertura:</label>
                                            <input type="range" id="opening1" min="1" max="15" value="3">
                                
                                            <label>Cierre:</label>
                                            <input type="range" id="closing1" min="1" max="15" value="3">
                                
                                            <label>Filtro de Paso Bajo:</label>
                                            <input type="range" id="low-pass1" min="1" max="100" value="30">
                                
                                            <label>Filtro de Paso Alto:</label>
                                            <input type="range" id="high-pass1" min="1" max="100" value="30">
                                
                                            <label>Filtro Gabor:</label>
                                            <input type="range" id="gabor1" min="0" max="100" value="50">
                                        </div>
                                    </div>
                                
                                    <!-- Imagen 2 -->
                                    <div class="col-md-6">
                                        <h3>Huella #2 (Filtrada)</h3>
                                        <img id="filtered-image2" src="" alt="Filtered Image 2" style="max-width: 100%; height: auto;">
                                
                                        <div class="filter-controls">
                                            <label>Ecualización de Histograma:</label>
                                            <input type="range" id="histogram-equalization2" min="0" max="100" value="50">
                                
                                            <label>Realce de Contraste:</label>
                                            <input type="range" id="enhance2" min="0" max="100" value="50">
                                
                                            <label>Filtro Mediana:</label>
                                            <input type="range" id="median2" min="1" max="15" value="3">
                                
                                            <label>Filtro Gaussiano:</label>
                                            <input type="range" id="gaussian2" min="1" max="15" value="3">
                                
                                            <label>Umbral:</label>
                                            <input type="range" id="threshold2" min="0" max="255" value="128">
                                
                                            <label>Umbral Adaptativo:</label>
                                            <input type="range" id="adaptive-threshold2" min="1" max="15" value="3">
                                
                                            <label>Dilatación:</label>
                                            <input type="range" id="dilation2" min="1" max="15" value="3">
                                
                                            <label>Erosión:</label>
                                            <input type="range" id="erosion2" min="1" max="15" value="3">
                                
                                            <label>Apertura:</label>
                                            <input type="range" id="opening2" min="1" max="15" value="3">
                                
                                            <label>Cierre:</label>
                                            <input type="range" id="closing2" min="1" max="15" value="3">
                                
                                            <label>Filtro de Paso Bajo:</label>
                                            <input type="range" id="low-pass2" min="1" max="100" value="30">
                                
                                            <label>Filtro de Paso Alto:</label>
                                            <input type="range" id="high-pass2" min="1" max="100" value="30">
                                
                                            <label>Filtro Gabor:</label>
                                            <input type="range" id="gabor2" min="0" max="100" value="50">
                                        </div>
                                    </div>
                                </div>
                                
                                
                            </div>
                            <div class="row text-center">
                                <button type="button" class="btn btn-success" onclick="applyFilter('grayscale')">Grayscale</button>
                                <button type="button" class="btn btn-success" onclick="applyFilter('sepia')">Sepia</button>
                                <button type="button" class="btn btn-success" onclick="applyFilter('invert')">Invert</button>
                            </div>
                            <div class="row text-center mt-3">
                                <div class="col-md-6">
                                    <label for="brightness">Brightness:</label>
                                    <input type="range" id="brightness" min="0" max="200" value="100" onchange="updateFilter()">
                                </div>
                                <div class="col-md-6">
                                    <label for="contrast">Contrast:</label>
                                    <input type="range" id="contrast" min="0" max="200" value="100" onchange="updateFilter()">
                                </div>
                            </div>
                            <div class="row text-center mt-3">
                                <div class="col-md-6">
                                    <label for="saturation">Saturation:</label>
                                    <input type="range" id="saturation" min="0" max="200" value="100" onchange="updateFilter()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.js"></script>

<script>
    let isLocked1 = false;
let isLocked2 = false;

function toggleLock(cropper) {
    if (cropper === cropper1) {
        isLocked1 = !isLocked1;
        cropper1.disable();  // Desactiva las interacciones con la imagen
        if (!isLocked1) cropper1.enable();  // Activa las interacciones si está desbloqueado
        alert(isLocked1 ? "Edición de Huella 1 bloqueada." : "Edición de Huella 1 desbloqueada.");
    } else if (cropper === cropper2) {
        isLocked2 = !isLocked2;
        cropper2.disable();
        if (!isLocked2) cropper2.enable();
        alert(isLocked2 ? "Edición de Huella 2 bloqueada." : "Edición de Huella 2 desbloqueada.");
    }
}

    var cropper1, cropper2;
    var image1 = document.getElementById('image1');
    cropper1 = new Cropper(image1, {
        autoCropArea: 0.65,
        responsive: true,
        zoomable: true,
        scalable: true,
        movable: true
    });
    var image2 = document.getElementById('image2');
    cropper2 = new Cropper(image2, {
        autoCropArea: 0.65,
        responsive: true,
        zoomable: true,
        scalable: true,
        movable: true
    });
    function loadImage(input, cropper) {
        var file = input.files[0];
        var reader = new FileReader();
        reader.onload = function (e) {
            var url = e.target.result;
            cropper.replace(url);
        };
        reader.readAsDataURL(file);
    }
    document.getElementById('inputImage1').addEventListener('change', function (e) {
        loadImage(e.target, cropper1);
    });
    document.getElementById('inputImage2').addEventListener('change', function (e) {
        loadImage(e.target, cropper2);
    });
    function setDragMode(cropper, mode) {
        cropper.setDragMode(mode);
    }

    function zoom(cropper, level) {
        cropper.zoom(level);
    }

    function rotate(cropper, degree) {
        cropper.rotate(degree);
    }

    function flip(cropper, direction) {
        cropper.scaleX(direction === 'horizontal' ? -1 : 1);
        cropper.scaleY(direction === 'vertical' ? -1 : 1);
    }

    function reset(cropper) {
        cropper.reset();
    }

    function destroy(cropper) {
        cropper.destroy();
    }

    function showFilteredImages() {
        var croppedImage1 = cropper1.getCroppedCanvas();
        var croppedImage2 = cropper2.getCroppedCanvas();
        document.getElementById('filtered-image1').src = croppedImage1.toDataURL();
        document.getElementById('filtered-image2').src = croppedImage2.toDataURL();
        document.getElementById('filter-section').style.display = 'block';
    }

    function applyFilter(filter) {
        var img1 = document.getElementById('filtered-image1');
        var img2 = document.getElementById('filtered-image2');
        if (filter === 'grayscale') {
            img1.style.filter = 'grayscale(100%)';
            img2.style.filter = 'grayscale(100%)';
        } else if (filter === 'sepia') {
            img1.style.filter = 'sepia(100%)';
            img2.style.filter = 'sepia(100%)';
        } else if (filter === 'invert') {
            img1.style.filter = 'invert(100%)';
            img2.style.filter = 'invert(100%)';
        }
    }

    function updateFilter() {
        var brightness = document.getElementById('brightness').value;
        var contrast = document.getElementById('contrast').value;
        var saturation = document.getElementById('saturation').value;

        var img1 = document.getElementById('filtered-image1');
        var img2 = document.getElementById('filtered-image2');

        img1.style.filter = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%)`;
        img2.style.filter = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%)`;
    }
    


    document.addEventListener('DOMContentLoaded', function () {
        const sliders = document.querySelectorAll('input[type="range"]');
        sliders.forEach(slider => {
            slider.addEventListener('input', applyFilters);
        });
    
        function applyFilters(event) {
            const filterSet = event.target.id.endsWith('1') ? 'filtered-image1' : 'filtered-image2';
            const image = document.getElementById(filterSet);
            const filters = {};
    
            sliders.forEach(slider => {
                if (slider.id.endsWith(filterSet.charAt(filterSet.length - 1))) {
                    filters[slider.id] = slider.value;
                }
            });
    
            fetch('/aplicar_filtros/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    image_data: image.src,
                    filters: filters
                })
            })
            .then(response => response.json())
            .then(data => {
                image.src = data.processed_image;
            })
            .catch(error => console.error('Error:', error));
        }
    });
    
</script>
{% endblock %}
{% endblock %}
